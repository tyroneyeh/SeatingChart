<!doctype html>
<html lang="zh-Hant-TW">
<head>
<title>TY's Seating Chart Generator</title>
  <meta name="description" content="SeatingChart Âπ´Âä©ËÄÅÂ∏´Âø´ÈÄüÁÆ°ÁêÜÊïôÂÆ§Â∫ß‰ΩçË°®ÔºåÊîØÊè¥Âç≥ÊôÇÁ∑®ËºØ„ÄÅÊãñÊãâÂ∫ß‰Ωç„ÄÅÈö®Ê©üÂÆâÊéí„ÄÅËá™Ë®ÇË°åÂàóËàáËÇ°Èï∑Ôºå‰∏¶ÂèØ‰ΩøÁî® JSON/Local Storage ÂÇô‰ªΩ„ÄÇPerfect for classroom management and roster planning.">
  <meta name="keywords" content="SeatingChart, online seating chart, VueJS 3, Bootstrap 5, teacher tools, classroom management, student seating, drag and drop, random seating, JSON storage, local storage, roster upload, ÊïôÂÆ§Â∫ß‰ΩçË°®, Â≠∏ÁîüÂ∫ß‰ΩçÂÆâÊéí, Áè≠Á¥öÁÆ°ÁêÜ, ÂêçÂñÆ‰∏äÂÇ≥, Èö®Ê©üÂ∫ß‰Ωç, ÊãñÊãâÂ∫ß‰Ωç, Êú¨Âú∞ÂÑ≤Â≠ò, JSON ÂÇô‰ªΩ">
  <meta name="author" content="TYÁöÑÁîüÊ¥ªË®òÈåÑ TY's Life in Taiwan">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="SeatingChart - ÊïôÂÆ§Â∫ß‰ΩçË°® & Online Student Seating Chart for Teachers">
  <meta property="og:description" content="Âø´ÈÄüÁÆ°ÁêÜÊïôÂÆ§Â∫ß‰ΩçË°®ÔºåÊîØÊè¥Âç≥ÊôÇÁ∑®ËºØ„ÄÅÊãñÊãâ„ÄÅÈö®Ê©üÂ∫ß‰Ωç„ÄÅË°åÂàóËá™Ë®Ç„ÄÅËÇ°Èï∑Ë®≠ÂÆöÔºå‰ª•Âèä JSON/Local Storage ÂÇô‰ªΩ„ÄÇPerfect for classroom management.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://tyroneyeh.github.io/SeatingChart/seatingchart.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="628">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SeatingChart - ÊïôÂÆ§Â∫ß‰ΩçË°® & Teacher-Friendly Online Student Seating Chart">
  <meta name="twitter:description" content="ÁÆ°ÁêÜÂ≠∏ÁîüÂ∫ß‰ΩçË°®ÔºåÊîØÊè¥Âç≥ÊôÇÁ∑®ËºØ„ÄÅÊãñÊãâ„ÄÅÈö®Ê©üÂ∫ß‰Ωç„ÄÅË°åÂàóËá™Ë®Ç„ÄÅËÇ°Èï∑Ë®≠ÂÆöÔºå‰ª•Âèä JSON/Local Storage ÂÇô‰ªΩ„ÄÇPerfect for teachers.">
<meta name="twitter:image" content="https://tyroneyeh.github.io/SeatingChart/seatingchart.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/gh/tyroneyeh/SeatingChart@main/index.js"></script>
<style>
[v-cloak] {
    display: none;
}
.seat-container {
    cursor: move;
}
.seat-container.color-0 { background-color: #fff; }
.seat-container.color-1 { background-color: #e0f7fa; }
.seat-container.color-2 { background-color: #e8f5e9; }
.seat-container.color-3 { background-color: #fffde7; }
.seat-container.color-4 { background-color: #f3e5f5; }
.seat-container.color-5 { background-color: #fce4ec; }
.seat-container.color-6 { background-color: #e3f2fd; }
.seat-container.color-7 { background-color: #ede7f6; }
.seat-container.color-8 { background-color: #f9fbe7; }
.seat-container.color-9 { background-color: #fff3e0; }
.seat-container.color-10 { background-color: #efebe9; }
.seat-container[draggable="true"]:hover {
    background-color: #f8f9fa;
}
.seat-container.dragging {
    opacity: 0.5;
}
.input-sm {
    width: 60px;
    height: 24px;
}
.table-cell {
    text-align: center;
    white-space: nowrap;
    padding: 1px;
}
.vertical-text {
    -webkit-writing-mode:vertical-lr;
    writing-mode:vertical-lr;
}
.text-justify-last {
  text-align-last: justify;
}
.seats {
    display: flex;
    flex-direction: column;
}
.child {
    flex: 1;
}
.possize {
    min-width:1.5em;
    min-height:1.5em;
}
.desk {
    border: 1px solid gray;
}
.w-50px {
    width: 50px;
}
.no-border-right {
    border-right: none !important;
}
.no-border-left {
    border-left: none !important;
}
.resize-x {
    resize: horizontal;
    overflow-x: auto;
    overflow-y: hidden;
}
.resize-y {
    resize: vertical;
    overflow-x: hidden;
    overflow-y: auto;
}
</style>
<style id="dynamic-zh-font" type="text/css"></style>
</head>
<body class="overflow-x-hidden">
<div id="app" class="w-auto" v-cloak>
    <div class="d-print-none m-1">
        <!-- top area -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" @click="toggleNavbar = !toggleNavbar" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="">üè† {{ $gettext("TY's Seating Chart Generator") }}</a>
                <div class="collapse navbar-collapse" :class="{show: toggleNavbar}">
                    <ul class="navbar-nav m-auto">
                        <a class="nav-link text-center">{{ $gettext('Columns') }}: <input type="number" class="w-50px" v-model="totalX" min="1" ref="totalxs" @change="store" @focus="$event.target.select()"></a>
                        <a class="nav-link text-center">{{ $gettext('Rows') }}: <input type="number" class="w-50px" v-model="totalY" min="1" ref="totalys" @change="store" @focus="$event.target.select()"></a>
                        <a class="nav-link text-center">{{ $gettext('Seats') }}: <input type="number" class="w-50px" min="1" ref="totalnums" @change="store" :value="totalX * totalY" :disabled="true"></a>
                        <button class="form-control-sm" @click="clearStore" v-if="storeData">{{ $gettext('Clear') }}</button>
                        <button class="form-control-sm" @click="download" v-if="storeData">{{ $gettext('Download') }}</button>
                        <input type="file" ref="uploadfile" @change="uploadfileChange" class="d-none" accept="application/json"><button class="form-control-sm" @click="uploadData">{{ $gettext('Upload') }}</button>
                        <button class="form-control-sm" @click="clearPos" :disabled="clearBtnCtl">{{ $gettext('Reset') }}</button>
                        <button class="form-control-sm" @click="randomPos" :disabled="posdata.filter(el => el.innerText.trim() != '').length >= namelist.filter(el => el.innerText.trim() != '').length">{{ $gettext('Random') }}</button>
                        <div class="navbar-nav border">
                            <button class="form-control-sm" :title="$gettext('Font size')" @click="adujstFont('+')">+</button>
                            <select class="text-center" v-model="fontPos"><option value="l">{{ $gettext('Left') }}</option><option value="c">{{ $gettext('Center') }}</option><option value="r">{{ $gettext('Right') }}</option></select>
                            <button class="form-control-sm" :title="$gettext('Font size')" @click="adujstFont('-')" :disabled="fontButtonCtl">-</button>
                        </div>
                        <label class="nav-link text-center"><input type="checkbox" v-model="showList">{{ $gettext('Lists') }}</label>
                        <label class="nav-link text-center"><input type="checkbox" v-model="showLeader">{{ $gettext('Leaders') }}</label>
                        <select class="text-center" @change="showFonts"><option>{{ $gettext('Fonts') }}</option><option value="zhuyin">{{ $gettext('ZhuYin') }}</option><option value="pinyin">{{ $gettext('PinYin') }}</option><option value="bothfonts">{{ $gettext('Both') }}</option></select>
                        <button class="form-control-sm" onclick="window.print()">{{ $gettext('Print') }}</button>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="alert alert-primary p-1 m-auto text-center" @click="tipsToHide" v-show="!hideTips">{{ $gettext('Please directly click on the name or seat number area to enter information') }}</div>
        <div class="row justify-content-center m-2">
            <a class="col-auto seat-container p-2 mx-1" v-for="(color, i) in colors" :class="[color, {'border': i == 0, 'border border-primary': colorIndex == i}]" style="cursor:pointer" @click="colorIndex = i"><span class="visually-hidden"></span></a>
        </div>
    </div>
    <div class="container-fluid row mx-auto" :style="{'font-size': fontSizeR + 'em'}">
        <div class="col-sm-3"></div>
        <div class="text-nowrap text-center col-sm-6" @blur="store" @click="startEdit($event.target)" @keydown.enter="endEdit" ref="tabletitle">{{ $gettext('Seating charts') }}</div>
        <div class="text-nowrap text-end col-sm-3"><span @blur="store" @click="startEdit($event.target)" @keydown.enter="endEdit" ref="updateLabel">{{ $gettext('Update') }}</span><span v-if="today.innerText != ''">: </span><span @blur="store" @click="startEdit($event.target)" @keydown.enter="endEdit" ref="today"></span></div>
    </div>

    <div class="container-fluid row mx-auto">
        <div class="col-lg-2 col-md-2 col-sm-2 pt-1 resize-y" v-show="showList">
            <!-- left area -->
            <table class="table table-bordered table-striped small">
                <thead>
                    <tr class="border-secondary small">
                        <th class="ps-3 py-1 no-border-right">
                            <input class="form-check-input d-print-none" type="checkbox" v-model="namesBgCtl" ref="nameBtnCtl">
                        </th>
                        <th colspan="2" class="text-nowrap py-1 no-border-left" :style="{'font-size': fontSizeL + 'em'}" @blur="store" @click="startEdit($event.target)" @keydown.enter="endEdit" ref="studentListLabel">
                            {{ $gettext('Lists') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="namelist-row" v-for="n in totalNamelist" @mouseover="showPos(n, 1)" @mouseout="showPos(n, 0)"
                        class="seat-container" :class="{'border-secondary': n % 5 == 0}" :style="{'font-size': fontSizeL + 'em'}" draggable="true" @dragstart="dragStart(n, 'student')" @dragover.prevent @drop="drop">
                        <td class="text-nowrap no-border-right p-1" :class="{'border-start': n % 5 == 0}">
                            <label class="w-100 d-inline-flex"><input class="form-check-input d-print-none" type="checkbox" @focus="showPos(n, 1)" @keydown="editKeydown('nameBgCtl', n)" ref="nameBgCtl" :checked="namesBgCtl">
                            <span class="d-none d-print-block px-1">{{ nameBgCtl[n - 1]?.checked == true ? '‚úì' : '‚òê' }}</span><span class="float-end">{{ n }}</span></label>
                        </td>
                        <td class="text-nowrap no-border-left py-1 namearea" :class="{'border-end': n % 5 == 0}" @focus="showPos(n, 1)" @blur="store" @paste="editPaste('namelist', n)" @keydown="editKeydown('namelist', n)" @click="startEdit($event.target)" ref="namelist"></td>
                    </tr>
                </tbody>
            </table>

        </div>
        <div class="bg-white seats px-0" :class="{'col-lg-8 col-md-7 col-sm-7': showList && showLeader, 'col-lg-10 col-md-10 col-sm-10': showList && !showLeader, 'col-lg-10 col-md-9 col-sm-9': !showList && showLeader, 'col-lg-12 col-md-12 col-sm-12': !showList && !showLeader}">
            <!-- center area -->
            <div class="row flex-nowrap child" :style="{'font-size': fontSizeC + 'em'}" v-for="y in totalY">
                <div class="col p-1" v-for="x in totalX">
                    <div class="p-0 seat-row seat-container border h-100" :class="{ 'bg-info': posdata[((y-1)*totalX + x-1)]?.innerText == highlightedPos }" @click="toggleColor" draggable="true" @dragstart="dragStart(((y-1)*totalX + x-1), 'seat')" @dragover.prevent @drop="drop(((y-1)*totalX + x-1))">
                        <div class="border-bottom text-center p-0 bg-light possize" @blur="store('posdata', $event.target.innerText, ((y-1)*totalX + x-1))" @paste="editPaste('posdata', ((y-1)*totalX + x-1))" @keydown="editKeydown('posdata', ((y-1)*totalX + x-1))" @click="startEdit($event.target)" ref="posdata"></div>
                        <div class="fs-6 text-light text-end p-0">{{ `${x}-${totalY - y + 1}` }}</div>
                        <div class="p-0 text-center mx-auto"><span class="text-nowrap p-0 vertical-text namearea" ref="posname"></span></div>
                    </div>
                </div>
            </div>
            <div class="row mx-auto m-2 resize-x" :style="{'font-size': fontSizeR + 'em'}">
                <div class="mx-auto text-center desk" @blur="store" @click="startEdit($event.target)" ref="deskname">{{ $gettext('Desk') }}</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-3 col-sm-3 pt-1" v-show="showLeader">
            <!-- right area -->
            <table class="table table-bordered table-striped" :style="{'font-size': fontSizeR + 'em'}">
                <thead>
                <tr>
                    <th colspan="2" class="text-justify-last bg-light" @blur="store" @click="startEdit($event.target)" ref="teacherLabel">{{ $gettext('Teacher') }}</th>
                </tr>
                <tr>
                    <td colspan="2" class="text-center ps-0 pe-0 text-nowrap namearea" :style="{'height': fontSizeR * 2 + 'em'}" @blur="store" @click="startEdit($event.target)" ref="teacher"></td>
                </tr>
                </thead>
                <tbody v-for="(n, index) in totalLeader">
                    <tr>
                        <th class="text-end text-nowrap text-justify-last" :style="{'height': fontSizeR * 2 + 'em'}" colspan="2" @blur="store" @click="startEdit($event.target)" @keydown="editKeydown('leadernames', n)" @paste="editPaste('leadernames', n)" ref="leadernames">{{ leadernames[n - 1]?.innerText }}</th>
                    </tr>
                    <tr class="leader-row" :style="{'height': fontSizeR * 2 + 'em'}" @mouseover="showPos(leaders[n - 1]?.innerText, 1)" @mouseout="showPos(leaders[n - 1]?.innerText, 0)" draggable="true" @dragstart="dragStart(index, 'leader')" @dragover.prevent @drop="drop(index)">
                        <td class="seat-container text-end no-border-right" @blur="store('leaders', $event.target.innerText, n)" @click="startEdit($event.target)" @keydown="editKeydown('leaders', n)" @paste="editPaste('leaders', n)" ref="leaders"></td>
                        <td class="seat-container text-nowrap namearea no-border-left" ref="leadersname"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="d-print-none text-end">
        <a href="https://github.com/tyroneyeh/SeatingChart/" target="_blank">
            <img src="https://img.shields.io/github/stars/tyroneyeh/SeatingChart" alt="GitHub stars" />
            <img src="https://img.shields.io/github/last-commit/tyroneyeh/SeatingChart" alt="GitHub last commit" />
            <img src="https://badgen.net/github/commits/tyroneyeh/SeatingChart" alt="GitHub last commit" />
            <img src="https://data.jsdelivr.com/v1/package/gh/tyroneyeh/SeatingChart/badge?style=rounded" alt="JSDelivr CDN" />
        </a>
    </footer>
</div>

<script>
'use strict';

window.randomNumbers = [];
const { createApp, ref, reactive, computed, nextTick } = Vue;

const app = createApp({
    beforeCreate() {
        const jsondata = localStorage.getItem('data');
        if (jsondata) {
            try {
                const data = JSON.parse(jsondata);

                const typeMap = {
                    totalNamelist: Number,
                    totalX: Number,
                    totalY: Number,
                    totalLeader: Number,
                    fontSizeR: parseFloat,
                    fontSizeC: parseFloat,
                    fontSizeL: parseFloat
                };

                window.dkeys = Object.entries(data);

                for (const [key, value] of window.dkeys) {
                    if (key == 'tabletitle') {
                        document.title = value;
                    } else if (key == 'today') {
                        this.today = value;
                    } else if (key in typeMap) {
                        this[key] = typeMap[key](value);
                    }
                }
            } catch (e) {}

        }
        this.hideTips = this.getCookie('hideTips') == 1;
    },
    setup() {

        const getCookie = (name) => {
            let value = '; ' + document.cookie;
            let parts = value.split(`; ${name}=`);
            if (parts.length == 2) return parts.pop().split(';').shift();
        };

        const setCookie = (name, value, age) => {
            age = undefined != age ? age : 60 * 60 * 24 * 14;
            document.cookie = `${name}=${value}; path=${location.pathname}; max-age=${age};`;
        };

        const removeCookie = (name, value) => {
            setCookie(name, value, 0);
        };

        const tipsToHide = () => {
            refs.hideTips.value = true;
            setCookie('hideTips', 1);
        };

        function getNameByNum(n) {
            const entry = storeRefs?.namelist[n - 1];
            return entry ? entry.innerText : "";
        }

        function setNameText(targetArr, index, num) {
            const name = getNameByNum(num);
            if (name) {
                targetArr[index].innerText = name;
            }
        }

        const updatedisplay = (o, num, pos) => {
            refs.totalnums.value = storeRefs.totalX.value * storeRefs.totalY.value;

            refs.clearBtnCtl.value = storeRefs.posdata.every(i => i.innerText.trim() == "");

            if (o == 'posdata' && num && pos) {
                setNameText(refs.posname, pos, num);
                const ctl = refs.nameBgCtl[parseInt(num) - 1];
                if (ctl) ctl.checked = true;
                addToRandomNumbers(num);
            } else if (o == 'leaders' && num) {
                setNameText(refs.leadersname, pos - 1, num);
            } else if (!o) {
                storeRefs.posdata.forEach((item, j) => {
                    refs.posname[j].innerText = '';
                    const sNum = parseInt(item.innerText.trim());
                    if (!isNaN(sNum)) {
                        setNameText(refs.posname, j, sNum);
                        addToRandomNumbers(sNum);
                        const ctl = refs.nameBgCtl[parseInt(sNum) - 1];
                        if (ctl) ctl.checked = true;
                    }
                });

                storeRefs.leaders.forEach((item, j) => {
                    const sNum = parseInt(item.innerText.trim());
                    if (!isNaN(sNum)) {
                        setNameText(refs.leadersname, j, sNum);
                    }
                });

                const filledSeats = storeRefs.posdata.filter(el => el.innerText.trim() != '').length;
                const filledNames = storeRefs.namelist.filter(el => el.innerText.trim() != '').length;
                refs.nameBtnCtl.value.checked = filledSeats >= filledNames;
            }
        };


        const store = (o, num, pos) => {

            const datakeys = Object.keys(storeRefs);
            const tojson = {};

            if (!storeRefs.namelist.filter(i => i.innerText.trim().length).length) storeRefs.totalNamelist.value = storeRefs.totalX.value * storeRefs.totalY.value;

            if (o?.target?.innerText != storeRefs.today.value.innerText) storeRefs.today.value.innerText = new Date().toLocaleDateString();

            datakeys.forEach((i) => {

                if (Array.isArray(storeRefs[i]))
                    tojson[i] = storeRefs[i].map((i) => { return i.innerText; });
                else if (storeRefs[i].value && storeRefs[i].value?.innerText && storeRefs[i].value?.innerText.trim().length)
                    tojson[i] = storeRefs[i].value.innerText;
                else if (storeRefs[i].value && storeRefs[i].value > 0)
                    tojson[i] = storeRefs[i].value;

            });

            localStorage.setItem('data', JSON.stringify(tojson));
            updatedisplay(o, num, pos);

        };

        const clearStore = () => {
            if (!confirm($gettext("Are you sure you want to clear all entered data?")))
                return;

            localStorage.removeItem('data');
            location.reload();
        };

        const clearPos = () => {
            if (!confirm($gettext("Are you sure you want to clear your current seating arrangement?")))
                return;

            storeRefs.posdata.forEach((i) => { if (i) i.innerText = ''; });
            store();
            location.reload();
        };

        const endEdit = () => {
            event.target?.removeAttribute('contenteditable');
            refs.editingEl.value = null;
        };

        const startEdit = (el) => {
            refs.editingEl.value?.removeAttribute('contenteditable');
            if (!el) return;
            el.setAttribute('contenteditable', 'true');
            refs.editingEl.value = el;
            nextTick(() => el.focus());
        };

        function focusAtEnd(el) {
            if (!el) return;
            el.focus();
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        const editKeydown = (o, n) => {
            const key = event.key;

            if (o == 'namelist') {
                if (n == storeRefs.totalNamelist.value && (key == 'Enter' || key == 'ArrowDown')) {
                    event.preventDefault();
                    storeRefs.totalNamelist.value++;
                    startEdit(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                } else if (n == storeRefs.totalNamelist.value && key == 'Backspace') {
                    if (storeRefs.namelist[storeRefs.totalNamelist.value - 1].innerText.trim().length) return;
                    event.preventDefault();
                    storeRefs.totalNamelist.value--;
                    startEdit(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                    focusAtEnd(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                } else if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.namelist[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.namelist[n]);
                }
            } else if (o == 'leadernames') {
                if (n == storeRefs.totalLeader.value && (key == 'Enter' || key == 'ArrowDown')) {
                    event.preventDefault();
                    storeRefs.totalLeader.value++;
                    startEdit(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                } else if (n == storeRefs.totalLeader.value && key == 'Backspace') {
                    if (storeRefs.leadernames[storeRefs.totalLeader.value - 1].innerText.trim().length) return;
                    event.preventDefault();
                    storeRefs.totalLeader.value--;
                    startEdit(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                    focusAtEnd(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                } else if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.leadernames[n - 2]);
                    focusAtEnd(storeRefs.leadernames[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.leadernames[n]);
                    focusAtEnd(storeRefs.leadernames[n]);
                }
            } else if (o == 'posdata') {
                if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n - storeRefs.totalX.value]);
                    focusAtEnd(storeRefs.posdata[n - storeRefs.totalX.value]);
                } else if (key == 'ArrowDown') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n + storeRefs.totalX.value]);
                    focusAtEnd(storeRefs.posdata[n + storeRefs.totalX.value]);
                } else if (key == 'ArrowLeft' || key == 'Backspace') {
                    const hasText = storeRefs.posdata[n].innerText.trim().length;
                    if (hasText && key == 'Backspace') return;
                    if (!hasText) refs.posname[n].innerText = '';
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n - 1]);
                    focusAtEnd(storeRefs.posdata[n - 1]);
                } else if (key == 'ArrowRight' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n + 1]);
                    focusAtEnd(storeRefs.posdata[n + 1]);
                }
            } else if (o == 'leaders') {
                if (key == 'ArrowUp' || key == 'Backspace') {
                    const hasText = storeRefs.leaders[n - 1].innerText.trim().length;
                    if (hasText && key == 'Backspace') return;
                    if (!hasText) refs.leadersname[n - 1].innerText = '';
                    event.preventDefault();
                    startEdit(storeRefs.leaders[n - 2]);
                    focusAtEnd(storeRefs.leaders[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.leaders[n]);
                }
            } else if (o == 'nameBgCtl') {
                if (key == 'ArrowUp') {
                    event.preventDefault();
                    refs.nameBgCtl[n - 2]?.focus();
                } else if (key == 'ArrowDown') {
                    event.preventDefault();
                    refs.nameBgCtl[n]?.focus();
                } else if (key == 'Enter') {
                    event.preventDefault();
                    refs.nameBgCtl[n - 1].checked = !refs.nameBgCtl[n - 1]?.checked;
                }
            }
        };


        function splitTextWithSpecialCaseSimple(text) {

            const segments = text.split(/[ „ÄÄ\n\t,Ôºå„ÄÅ]+/).filter(segment => segment.length > 0);
            const result = [];
            let i = 0;
            while (i < segments.length) {
                if (i + 1 < segments.length && segments[i].length == 1 && segments[i + 1].length == 1) {
                    result.push(`${segments[i]} ${segments[i + 1]}`);
                    i += 2;
                } else {
                    result.push(segments[i]);
                    i++;
                }
            }

            return result.filter(segment => segment.replace(/\s/g, '').length >= 2);
        }

        const editPaste = (o, n) => {

             const pasteData = splitTextWithSpecialCaseSimple(event.clipboardData.getData('text').trim());
             if (!['namelist', 'leadernames'].includes(o) || !pasteData?.length) return;

            event.preventDefault();

            const list = storeRefs[o];
            const startIndex = n - 1;

            pasteData.forEach((text, j) => {
                const item = list[startIndex + j];
                if (!item) return;
                item.innerText = text.replace(/(['"])(.*?)\1/g, '$2').trim();
            });

        };

        const download = () => {
            const data = localStorage.getItem('data');

            if (data) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
                const dlAnchorElem = document.createElement('a');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", `${storeRefs.tabletitle.value.textContent || $gettext('Seating charts')}.json`);
                document.body.appendChild(dlAnchorElem);
                dlAnchorElem.click();
                document.body.removeChild(dlAnchorElem);
            }
        };

        const uploadData = () => {
            if (refs.uploadfile.value) {
                refs.uploadfile.value.click();
            }
        };

        const randomPos = () => {
            let rNum, i, studentNums;
            // Ensure namelist is not empty and has valid elements
            for (i = storeRefs.totalNamelist.value; i > 0; i--) {
                if (storeRefs.namelist[i - 1]?.innerText.trim().length) break;
            }

            if (i <= window.randomNumbers.length) return;

            studentNums = Array.from({length: i}, (_, index) => 1 + index);
            if (window.randomNumbers.length)
                studentNums = studentNums.filter(num => !window.randomNumbers.includes(num));

            const posdatas = storeRefs.posdata.slice().reverse();
            for (const element of posdatas) {
                if (!element.innerText.trim().length) {
                    rNum = Math.floor(Math.random() * studentNums.length);
                    // Check for valid index and valid namelist entry
                    if (storeRefs.namelist[studentNums[rNum] - 1]?.innerText.trim().length) {
                        element.innerText = studentNums[rNum];
                    } else {
                        continue;
                    }

                    studentNums.splice(rNum, 1);
                    if (!studentNums.length) break;
                }
            }

            store();
            location.reload();
        };

        const uploadfileChange = () => {
            const fileInput = refs.uploadfile.value;
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return;
            const reader = new FileReader();
            reader.readAsText(fileInput.files[0], "UTF-8");
            reader.onload = (evt) => {
                localStorage.setItem('data', evt.target.result);
                location.reload();
            }
        };

        const showPos = (n, show) => {
            refs.highlightedPos.value = show ? n : null;
        };

        const dragStart = (index, type) => {
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: type, index: index }));
            event.target.classList.add('dragging', `${type}-row`);
        };

        function removeFromRandomNumbers(num) {
            window.randomNumbers = window.randomNumbers.filter(n => n != num);
        }

        function addToRandomNumbers(num) {
            if (num && !window.randomNumbers.includes(String(num))) {
                window.randomNumbers.push(String(num));
            }
        }

        function swapElements(arr, idx1, idx2) {
            const val1 = parseInt(arr[idx1]?.innerText || '');
            const val2 = parseInt(arr[idx2]?.innerText || '');

            if (arr[idx1]) arr[idx1].innerText = val2 || '';
            if (arr[idx2]) arr[idx2].innerText = val1 || '';

        }

        function setElementValue(arr, idx, value) {
            if (arr[idx]) arr[idx].innerText = value || '';
        }

        const drop = (targetIndex) => {
            event.preventDefault();
            event.stopPropagation();

            const data = JSON.parse(event.dataTransfer.getData('text/plain') || '{}');
            const isNamelistRow = event.currentTarget.classList.contains('namelist-row');
            const isLeaderRow = event.currentTarget.classList.contains('leader-row');
            const isSeatRow = event.currentTarget.classList.contains('seat-row');

            const targetNum = isLeaderRow ? parseInt(storeRefs.leaders[targetIndex]?.innerText || '') : parseInt(storeRefs.posdata[targetIndex]?.innerText || '');

            const sourceIndex = parseInt(data.index);

            const actions = [{
                condition: () => data.type == 'student' && isSeatRow,
                action: () => {
                    if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                    if (window.randomNumbers.includes(String(sourceIndex))) {
                        alert($gettext('Seat assigned'));
                        return;
                    }
                    if (targetNum) removeFromRandomNumbers(targetNum);
                    setElementValue(storeRefs.posdata, targetIndex, sourceIndex);
                    addToRandomNumbers(sourceIndex);
                }
                },
                {
                    condition: () => data.type == 'seat' && isSeatRow,
                    action: () => {
                        if (sourceIndex == targetIndex) return;
                        swapElements(storeRefs.posdata, sourceIndex, targetIndex);
                    }
                },
                {
                    condition: () => data.type == 'seat' && isLeaderRow,
                    action: () => {
                        if (sourceIndex == targetIndex) return;
                        const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                        setElementValue(storeRefs.leaders, targetIndex, sourceNum);
                    }
                },
                {
                    condition: () => data.type == 'seat' && isNamelistRow,
                    action: () => {
                        const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                        window.randomNumbers = window.randomNumbers.filter((i) => { return i != sourceNum; });
                        if (refs.nameBgCtl[sourceNum - 1]) refs.nameBgCtl[sourceNum - 1].checked = false;
                        setElementValue(storeRefs.posdata, sourceIndex, '');
                    }
                },
                {
                    condition: () => data.type == 'leader' && isLeaderRow,
                    action: () => {
                        if (sourceIndex == targetIndex) return;
                        swapElements(storeRefs.leaders, sourceIndex, targetIndex);
                        if (!storeRefs.leaders[sourceIndex]?.innerText.trim().length) {
                            setElementValue(refs.leadersname, sourceIndex, '');
                        }
                    }
                },
                {
                    condition: () => data.type == 'student' && isLeaderRow,
                    action: () => {
                        if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                        setElementValue(storeRefs.leaders, targetIndex, sourceIndex);
                    }
                }
            ];

            for (const { condition, action } of actions) {
                if (condition()) {
                    action();
                    break;
                }
            }

            document.querySelectorAll('.seat-container').forEach(el => el.classList.remove('dragging'));
            store();
        };

        const toggleColor = (event) => {
            const el = event.currentTarget;
            let currentIndex = refs.colors.findIndex(c => el.classList.contains(c));

            if (currentIndex == -1) {
                el.classList.add(refs.colors[(refs.colorIndex.value > 0) ? refs.colorIndex.value : 0]);
                return;
            }
            el.classList.remove(refs.colors[currentIndex]);
            if (currentIndex == refs.colors.length - 1) {
                return;
            }
            if (refs.colorIndex.value != 0) el.classList.add(refs.colors[currentIndex + 1]);
        };

        const fontSizeMap = {
            r: "fontSizeR",
            c: "fontSizeC",
            l: "fontSizeL"
        };
        const adujstFont = (direction) => {

            const key = fontSizeMap[refs.fontPos.value];
            if (key) {
                const val = storeRefs[key].value + (direction == "+" ? 0.1 : -0.1);
                if (val >= 0.5) {
                    storeRefs[key].value = Math.round(val * 10) / 10;
                    store();
                }
            }
        };

        const fontButtonCtl = computed(() => {
            const key = fontSizeMap[refs.fontPos.value];
            return storeRefs[key].value <= 0.5;
        });

        const showFonts = () => {
            const el = document.getElementById('dynamic-zh-font');
            const fonts = {
                zhuyin: {
                    family: 'BpmfZihiKai',
                    file: 'https://cdn.jsdelivr.net/gh/ButTaiwan/bpmfvs/outputs/BpmfZihiKaiStd-Regular.ttf',
                    type: 'truetype'
                },
                pinyin: {
                    family: 'Pinyin-Tsuipita',
                    file: 'https://cdn.jsdelivr.net/gh/tyroneyeh/SeatingChart/ToneOZ-Pinyin-Tsuipita-TC.woff2',
                    type: 'woff2'
                },
                bothfonts: {
                    family: 'YinPZ-Tsuipita',
                    file: 'https://cdn.jsdelivr.net/gh/tyroneyeh/SeatingChart/ToneOZ-YinPZ-Tsuipita-TC.woff2',
                    type: 'woff2'
                }
            };
            const f = fonts[event.target.value];
            if (f) {
                el.innerHTML = `@font-face {font-family: '${f.family}';src: url('${f.file}') format('${f.type}');font-weight: normal;font-style: normal;}.namearea {font-family: '${f.family}';}`;
            } else {
                el.innerHTML = '';
            }
        };

        const storeRefs = {
            tabletitle: ref($gettext('Seating charts')),
            today: ref(new Date().toLocaleDateString()),
            totalX: ref(6),
            totalY: ref(8),
            totalNamelist: ref(48),
            totalLeader: ref(8),
            namelist: reactive([]),
            posdata: reactive([]),
            teacher: ref(null),
            leadernames: reactive([]),
            leaders: reactive([]),
            deskname: ref($gettext('Desk')),
            updateLabel: ref($gettext('Update')),
            teacherLabel: ref($gettext('Teacher')),
            studentListLabel: ref($gettext('Lists')),
            fontSizeL: ref(1),
            fontSizeC: ref(1.8),
            fontSizeR: ref(1.2)
        };

        const refs = {
            toggleNavbar: ref(false),
            totalnums: ref(48),
            uploadfile: ref(null),
            storeData: ref(0),
            posname: reactive([]),
            posindex: ref(0),
            leadersname: reactive([]),
            clearBtnCtl: ref(0),
            isDataChanged: ref(0),
            namesBgCtl: ref(0),
            nameBgCtl: reactive([]),
            hideTips: ref(false),
            highlightedPos: ref(null),
            colors: reactive([...Array(10)].map((_, i) => `color-${i}`)),
            colorIndex: ref(-1),
            currentTarget: ref(null),
            currentIndex: ref(0),
            showList: ref(true),
            showLeader: ref(true),
            fontPos: ref('c'),
            nameBtnCtl: ref(false),
            editingEl: ref(null)
        };

        return {
            ...storeRefs,
            ...refs,
            startEdit,
            endEdit,
            editKeydown,
            editPaste,
            store,
            clearStore,
            download,
            uploadData,
            randomPos,
            clearPos,
            uploadfileChange,
            updatedisplay,
            tipsToHide,
            getCookie,
            showPos,
            dragStart,
            drop,
            toggleColor,
            adujstFont,
            fontButtonCtl,
            showFonts
        };
    },
    mounted() {

        if (document.title == "TY's Seating Chart Generator") document.title = $gettext('Seating charts');

        if (this.leadernames) {
            if (this.leadernames[0] && !this.leadernames[0].innerText.length) this.leadernames[0].innerText = $gettext('President');
            if (this.leadernames[1] && !this.leadernames[1].innerText.length) this.leadernames[1].innerText = $gettext('Vice president');
        }

        window.dkeys?.forEach((i) => {

            if (Array.isArray(i[1]) && i[1][0] != null) {
                i[1].forEach((_, j) => {
                    if (this[i[0]] && undefined != this[i[0]][j]?.innerText)
                        this[i[0]][j].innerHTML = i[1][j];
                });
            } else if (undefined != this[i[0]]?.innerText)
                this[i[0]].innerText = i[1];
            else if (undefined != this[i[0]]?.value)
                this[i[0]].value = i[1];

        });

        this.updatedisplay();
        this.storeData = 1;
    }

});

const vue3gettext = VueGettext.createGettext({
    availableLanguages: {
        en: "English",
        zh_TW: "Chinese"
    },
    silent: true,
    defaultLanguage: navigator.language.replace(/-/, '_'),
    translations: {
        "zh_TW": {
            "TY's Seating Chart Generator": "TYÁöÑÂ∫ß‰ΩçË°®Áî¢ÁîüÂô®",
            "Seat assigned": "Â∑≤Êéí‰ΩçÂ≠ê",
            "Are you sure you want to clear all entered data?": "Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÂÖ®ÈÉ®Ëº∏ÂÖ•ÁöÑË≥áÊñôÂóé?",
            "Are you sure you want to clear your current seating arrangement?": "Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÁõÆÂâçÁöÑÂ∫ß‰ΩçÊéíÂàóÂóé?",
            "President": "Áè≠Èï∑",
            "Clear": "Ê∏ÖÈô§",
            "Desk": "Ë¨õÊ°å",
            "Download": "‰∏ãËºâ",
            "Not enough seats!": "Â∫ß‰ΩçÊï∏‰∏çÂ§†Âùê!",
            "Columns": "Êéí",
            "Leaders": "ËÇ°Èï∑",
            "Seats": "Â∫ß‰Ωç",
            "Rows": "Âàó",
            "Please directly click on the name or seat number area to enter information": "Ë´ãÁõ¥Êé•ÈªûÈÅ∏ÂßìÂêçÊàñÂ∫ßËôüÂçÄÂüüËº∏ÂÖ•Ë≥áÊñô",
            "Random": "Èö®Ê©ü",
            "Reset": "ÈáçÁΩÆ",
            "Seating charts": "Â∫ß‰ΩçË°®",
            "Lists": "ÂêçÂñÆ",
            "Teacher": "Â∞éÂ∏´",
            "Update": "Êõ¥Êñ∞Êó•Êúü",
            "Upload": "‰∏äÂÇ≥",
            "Vice president": "ÂâØÁè≠Èï∑",
            "Left": "Â∑¶",
            "Center": "‰∏≠",
            "Right": "Âè≥",
            "Font size": "Â≠óÈ´îÂ§ßÂ∞è",
            "Lists": "ÂêçÂñÆ",
            "Leaders": "ËÇ°Èï∑",
            "Fonts": "Â≠óÈ´î",
            "ZhuYin": "Ê≥®Èü≥",
            "PinYin": "ÊãºÈü≥",
            "Both": "ÂÖ©ËÄÖ",
            "Print": "ÂàóÂç∞"
        }
    }
});

window.$gettext = vue3gettext.$gettext;
app.use(vue3gettext).mount('#app');

</script>
</body>
</html>

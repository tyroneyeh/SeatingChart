<!doctype html>
<html lang="zh-Hant-TW">
<head>
<title>Loading</title>
  <meta name="description" content="SeatingChart å¹«åŠ©è€å¸«å¿«é€Ÿç®¡ç†æ•™å®¤åº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ã€æ‹–æ‹‰åº§ä½ã€éš¨æ©Ÿå®‰æ’ã€è‡ªè¨‚è¡Œåˆ—èˆ‡è‚¡é•·ï¼Œä¸¦å¯ä½¿ç”¨ JSON/Local Storage å‚™ä»½ã€‚Perfect for classroom management and roster planning.">
  <meta name="keywords" content="SeatingChart, online seating chart, VueJS 3, Bootstrap 5, teacher tools, classroom management, student seating, drag and drop, random seating, JSON storage, local storage, roster upload, æ•™å®¤åº§ä½è¡¨, å­¸ç”Ÿåº§ä½å®‰æ’, ç­ç´šç®¡ç†, åå–®ä¸Šå‚³, éš¨æ©Ÿåº§ä½, æ‹–æ‹‰åº§ä½, æœ¬åœ°å„²å­˜, JSON å‚™ä»½">
  <meta name="author" content="TYçš„ç”Ÿæ´»è¨˜éŒ„ TY's Life in Taiwan">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="SeatingChart - æ•™å®¤åº§ä½è¡¨ & Online Student Seating Chart for Teachers">
  <meta property="og:description" content="å¿«é€Ÿç®¡ç†æ•™å®¤åº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ã€æ‹–æ‹‰ã€éš¨æ©Ÿåº§ä½ã€è¡Œåˆ—è‡ªè¨‚ã€è‚¡é•·è¨­å®šï¼Œä»¥åŠ JSON/Local Storage å‚™ä»½ã€‚Perfect for classroom management.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://tyroneyeh.github.io/SeatingChart/seatingchart.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="628">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SeatingChart - æ•™å®¤åº§ä½è¡¨ & Teacher-Friendly Online Student Seating Chart">
  <meta name="twitter:description" content="ç®¡ç†å­¸ç”Ÿåº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ã€æ‹–æ‹‰ã€éš¨æ©Ÿåº§ä½ã€è¡Œåˆ—è‡ªè¨‚ã€è‚¡é•·è¨­å®šï¼Œä»¥åŠ JSON/Local Storage å‚™ä»½ã€‚Perfect for teachers.">
<meta name="twitter:image" content="https://tyroneyeh.github.io/SeatingChart/seatingchart.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://tyroneyeh.github.io/SeatingChart/index.js"></script>
<style>
[v-cloak] {
    display: none;
}
.seat-cell {
    min-height: 26px;
    border: 1px solid gray;
    text-align: center;
}
.seat-name {
    writing-mode: vertical-lr;
    -webkit-writing-mode: vertical-lr;
    height: 100px;
    padding: 3px;
}
.seat-container {
    cursor: move;
}
.seat-container.color-0 {
    background-color: #e0f7fa;
}
.seat-container.color-1 {
    background-color: #e8f5e9;
}
.seat-container.color-2 {
    background-color: #fffde7;
}
.seat-container[draggable="true"]:hover {
    background-color: #f8f9fa;
}
.seat-container.dragging {
    opacity: 0.5;
}
.input-sm {
    width: 60px;
    height: 24px;
}
.table-cell {
    text-align: center;
    white-space: nowrap;
    padding: 1px;
}
</style>
</head>
<body>
<div id="app" class="container-fluid" v-cloak>
    <div class="d-print-none card m-1">
        <!-- top area -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="">ğŸ </a>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav m-auto">
                        <span class="nav-link">{{ $gettext('Number of columns') }}: <input type="number" style="width:60px" v-model.lazy="totalX" min="1" ref="totalxs" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link">{{ $gettext('Number of rows') }}: <input type="number" style="width:60px" v-model.lazy="totalY" min="1" ref="totalys" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link" aria-current="page">{{ $gettext('Number of seats') }}: <input type="number" style="width:60px" v-model="totalNamelist" min="1" ref="totalnums" @change="store" :value="totalX * totalY" disabled></span>
                        <span class="nav-link">{{ $gettext('Number of leaders') }}: <input type="number" style="width:60px" v-model.lazy="totalLeader" min="1" :max="totalNamelist" ref="totalleaders" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link"><button class="form-control-sm" @click="clearStore" v-if="storeData">{{ $gettext('Clear data') }}</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="download" v-if="storeData">{{ $gettext('Download data') }}</button></span>
                        <span class="nav-link"><input type="file" ref="uploadfile" @change="uploadfileChange" class="d-none" accept="application/json"><button class="form-control-sm" @click="uploadData">{{ $gettext('Upload data') }}</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="clearPos" :disabled="clearBtnCtl">{{ $gettext('Reset seats') }}</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="randomPos">{{ $gettext('Random seats') }}</button></span>
                    </div>
                </div>
            </div>
        </nav>
        <div class="input-group-text m-auto" @click="tipsToHide" v-show="!hideTips">{{ $gettext('Please directly click on the name or seat number area to enter information') }}</div>

    </div>
    <div class="row m-auto" :class="xColClass">
        <div class="col-1"></div>
        <div class="text-center col-10" @click="clickToEdit" ref="tabletitle">{{ $gettext('Seats charts') }}</div>
        <div class="col-1 align-self-end text-nowrap"><span @click="clickToEdit" ref="updateLabel">{{ $gettext('Update') }}</span>: <span @click="clickToEdit" ref="today">{{ new Date().toLocaleDateString() }} </span></div>
    </div>

    <div class="row col-sm-12 mx-auto" :class="xColClass">
        <div class="pt-1" :class="xColClassStart">
            <!-- left area -->
            <table class="table table-bordered table-striped small">
                <thead>
                    <tr class="border-secondary small">
                        <th class="col-2 ps-2 py-1 border-end">
                            <input class="form-check-input d-print-none" type="checkbox" v-model="namesBgCtl">
                        </th>
                        <th class="col text-center text-nowrap py-1 small" @click="clickToEdit" ref="studentListLabel">
                            {{ $gettext('Lists') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(n, index) in totalNamelist" @mouseover="showPos(n, 1)" @mouseout="showPos(n, 0)"
                        class="seat-container small" :class="{'border-bottom border-secondary': (index + 1) % 5 === 0}" draggable="true" @dragstart="dragStart(n, 'student', $event)">
                        <td class="text-center text-nowrap ps-0 pe-0 border-start border-end py-1">
                            <input class="form-check-input d-print-none" type="checkbox" ref="nameBgCtl" :checked="namesBgCtl">
                            {{ String(n).padStart(2, '0') }}
                        </td>
                        <td class="text-nowrap border-start border-end border-end py-1"
                            @click="clickToEdit($event, 'namelist', n)" ref="namelist"></td>
                    </tr>
                </tbody>
            </table>

        </div>
        <div class="ps-4 pb-3" :class="xColClassCenter">
            <!-- center area -->
            <div class="row flex-nowrap" v-for="y in totalY">
                <div class="col p-1" v-for="x in totalX">
                    <div class="col p-0 seat-row seat-container border h-100" :class="{ 'bg-warning': posdata[((y-1)*totalX + x-1)]?.innerText === highlightedPos }" @click="toggleColor" draggable="true" @dragstart="dragStart(((y-1)*totalX + x-1), 'seat', $event)" @dragover.prevent @drop="drop(((y-1)*totalX + x-1), $event)">
                        <div class="col border-bottom text-center" @click="clickToEdit($event, 'posdata', x, y)" style="min-height:26px" ref="posdata"></div>
                        <div class="col text-center w-100 small" style="min-height:100px"><div class="small text-light text-end">{{ `${totalY - y + 1} - ${x}` }}</div><span class="text-nowrap fs-5" style="-webkit-writing-mode:vertical-lr;writing-mode:vertical-lr" ref="posname"></span></div>
                    </div>
                </div>
            </div>
            <div class="row m-4">
                <div class="mx-auto text-center" style="border: 1px solid gray;" @click="clickToEdit" ref="deskname">{{ $gettext('Desk') }}</div>
            </div>
        </div>
        <div class="pt-1" :class="xColClassEnd">
            <!-- right area -->
            <table class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th style="text-align-last:justify" @click="clickToEdit" ref="teacherLabel">{{ $gettext('Teacher') }}</th>
                    <th colspan="2" class="w-50 text-center ps-0 pe-0 text-nowrap" @click="clickToEdit" ref="teacher"></th>
                </tr>
                </thead>
                <tr v-for="(n, index) in totalLeader" class="leader-row" draggable="true" @dragstart="dragStart(index, 'leader', $event)" @dragover.prevent @drop="drop(index, $event)">
                    <td class="text-end text-nowrap" style="text-align-last:justify" @click="clickToEdit($event, 'leadernames', n)" ref="leadernames">{{ leadernames[n - 1]?.innerText }}</td>
                    <td class="seat-container text-center" style="width:50px" @click="clickToEdit($event, 'leaders', n)" ref="leaders"></td>
                    <td class="seat-container text-nowrap" ref="leadersname">&nbsp;</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
window.randomNumbers = [];
const { createApp, ref, reactive, watch } = Vue;

const app = createApp({
    setup() {

        const getCookie = (name) => {
            let value = '; ' + document.cookie;
            let parts = value.split(`; ${name}=`);
            if (parts.length == 2) return parts.pop().split(';').shift();
        };

        const setCookie = (name, value, age) => {
            age = undefined != age ? age : 60 * 60 * 24 * 14;
            document.cookie = `${name}=${value}; path=${location.pathname}; max-age=${age};`;
        };

        const removeCookie = (name, value) => {
            setCookie(name, value, 0);
        };

        const tipsToHide = () => {
            refs.hideTips.value = true;
            setCookie('hideTips', 1);
        };

        const updatedisplay = (o, num, pos) => {

            if ('posdata' == o && num && pos) {
                const no = storeRefs?.namelist[num - 1];
                if (no) {
                    refs.posname[pos].innerText = no.innerText;
                    !window.randomNumbers.includes(num) && window.randomNumbers.push(num);
                }
            } else if ('leaders' == o && num) {
                const no = storeRefs?.namelist[num - 1];
                no && (refs.leadersname[pos - 1].innerText = no.innerText);
            } else if (!o) {
                storeRefs.posdata.forEach((i, j) => {
                    refs.posname[j].innerText = '';
                    num = parseInt(i.innerText.trim());
                    if (!isNaN(num)) {
                        const no = storeRefs?.namelist[num - 1];
                        if (no) {
                            refs.posname[j].innerText = no.innerText;
                            !randomNumbers.includes(num) && randomNumbers.push(num);
                            refs.nameBgCtl[num - 1].checked = true;
                        }
                    }
                });

                storeRefs.leaders.forEach((i, j) => {
                    num = parseInt(i.innerText.trim());
                    if (!isNaN(num)) {
                        const no = storeRefs.namelist[num - 1];
                        no && (refs.leadersname[j].innerText = no.innerText);
                    }
                });
            }

        };

        const store = (o, num, pos) => {
            const datakeys = Object.keys(storeRefs);
            const tojson = {};
            datakeys.forEach((i) => {

                if (Array.isArray(storeRefs[i]))
                    tojson[i] = storeRefs[i].map((i) => { return i.innerText; });
                else if (storeRefs[i].value && storeRefs[i].value?.innerText && storeRefs[i].value?.innerText.trim().length)
                    tojson[i] = storeRefs[i].value.innerText;
                else if (storeRefs[i].value && storeRefs[i].value > 0)
                    tojson[i] = storeRefs[i].value;

            });

            localStorage.setItem('data', JSON.stringify(tojson));
            updatedisplay(o, num, pos);

        };

        const clearStore = () => {
            if (!confirm($gettext("Are you sure you want to clear all entered data?")))
                return;

            localStorage.removeItem('data');
            location.reload();
        };

        const clearPos = () => {
            if (!confirm($gettext("Are you sure you want to clear your current seating arrangement?")))
                return;

            storeRefs.posdata.forEach((i) => { if (i) i.innerText = ''; });
            store();
            location.reload();
        };

        const clickToEdit = (event, o, n, y) => {
            const editInput = event?.target;

            if (!editInput)
                return;

            const hasFS4Class = editInput.classList.value.includes('fs-4');
            editInput.classList.remove('fs-4');
            const inputElement = document.createElement('input');
            inputElement.classList.add('from-control-sm');
            inputElement.setAttribute('type', 'text');
            if (['posdata', 'leaders'].includes(o)) {
                inputElement.setAttribute('type', 'number');
                inputElement.setAttribute('min', 1);
                inputElement.setAttribute('max', storeRefs.totalNamelist.value);
            }

            inputElement.style.width = "100%";
            inputElement.style.minWidth = '50px';
            inputElement.style.height = "24px";
            inputElement.value = editInput.innerText.trim();

            window.randomNumbers = window.randomNumbers.filter(e => e != parseInt(inputElement.value));
            const num = parseInt(inputElement.value);
            if ('posdata' == o && num)
                refs.nameBgCtl[num - 1].checked = false;

            editInput.innerHTML = '';
            editInput.appendChild(inputElement);

            const blurFunc = (o, n, y, hasFS4Class) => {
                const num = parseInt(inputElement.value);
                let pos = n;
                if (['posdata', 'leaders'].includes(o) && !isNaN(num)) {
                    if (num > storeRefs.totalNamelist.value) {
                        editInput.innerText = '';
                        return;
                    }
                    if ('posdata' == o) {
                        if (!isNaN(n) && !isNaN(y)) {
                            pos = ((y - 1) * storeRefs.totalX.value + n) - 1;
                        }
                        if (randomNumbers.includes(num)) {
                            alert($gettext('Seat assigned'));
                            editInput.innerText = '';
                            setTimeout(() => {
                                const targetEl = storeRefs[o][((y - 1) * storeRefs.totalX.value + n) - 1];
                                if (targetEl) targetEl.click();
                            }, 50);
                            return;
                        }
                        num && (refs.nameBgCtl[num - 1].checked = true);
                    }
                    editInput.innerText = String(inputElement.value).padStart(2, '0');
                } else {
                    hasFS4Class && editInput.classList.add('fs-4');
                    editInput.innerText = inputElement.value;
                }

                store(o, num, pos);
                refs.storeData.value = 1;
            };

            inputElement.addEventListener('blur', () => blurFunc(o, n, y, hasFS4Class));

            inputElement.addEventListener('keydown', (e) => {
                if (undefined == n) return;
                if ((e.shiftKey && 'Tab' == e.key) || (e.shiftKey && 'Enter' == e.key) || ('ArrowUp' == e.key && !y)) {
                    e.preventDefault();
                    if (y)
                        storeRefs[o][((y - 1) * storeRefs.totalX.value + n) - 2]?.click();
                    else
                        storeRefs[o][n - 2]?.click();
                } else if (['Enter', 'Tab'].includes(e.key) || ('ArrowDown' == e.key && !y)) {
                    e.preventDefault();
                    if (y)
                        storeRefs[o][(y - 1) * storeRefs.totalX.value + n]?.click();
                    else if (['leadernames', 'leaders'].includes(o) && storeRefs.totalLeader.value <= storeRefs.leadernames.length && n == storeRefs.leadernames.length)
                        storeRefs.totalLeader.value++;
                    else if ('namelist' == o && storeRefs.totalNamelist.value <= storeRefs[o].length && n == storeRefs.totalNamelist.value)
                        storeRefs.totalNamelist.value++;

                    if (['namelist', 'leadernames', 'leaders'].includes(o) && undefined != storeRefs[o])
                        setTimeout(() => {
                            if (storeRefs[o][n]) storeRefs[o][n].click();
                        }, 50);
                } else if (e.shiftKey && 'Tab' == e.key && y || 'ArrowLeft' == e.key) {
                    e.preventDefault();
                    storeRefs[o][((y - 1) * storeRefs.totalX.value + n) - 2]?.click();
                } else if (['Enter', 'Tab'].includes(e.key) && y || 'ArrowRight' == e.key) {
                    e.preventDefault();
                    storeRefs[o][(y - 1) * storeRefs.totalX.value + n]?.click();
                } else if ('Backspace' == e.key) {
                    switch(o) {
                    case 'namelist':
                    case 'leadernames':
                    case 'leaders':
                        if (!e.target.value.length && !storeRefs[o][n - 1]?.innerText.trim().length) {
                            e.preventDefault();
                            const totalObj = storeRefs['total'+ o.charAt(0).toUpperCase() + o.slice(1)];
                            if (totalObj && n == totalObj.value)
                                totalObj.value--;
                            else if (n == storeRefs.totalLeader.value)
                                storeRefs.totalLeader.value--;

                            setTimeout(() => {
                                storeRefs[o][n - 2]?.click();
                            }, 50);
                        }
                        break;
                    case 'posdata':
                        if (!e.target.value.length) {
                            e.preventDefault();
                            storeRefs[o][((y - 1) * storeRefs.totalX.value + n) - 2]?.click();
                        }
                    }
                }

            });

            function splitTextWithSpecialCaseSimple(text) {

                const segments = text.split(/[\s\n\t,]+/).filter(segment => segment.length > 0);
                const result = [];
                let i = 0;
                while (i < segments.length) {
                    if (i + 1 < segments.length && segments[i].length === 1 && segments[i + 1].length === 1) {
                        result.push(`${segments[i]} ${segments[i + 1]}`);
                        i += 2;
                    } else {
                        result.push(segments[i]);
                        i++;
                    }
                }

                return result.filter(segment => segment.replace(/\s/g, '').length >= 2);
            }

            const pasteNameImport = (o, n, event) => {
                const pasteData = splitTextWithSpecialCaseSimple(event.clipboardData.getData('text').trim());
                if (pasteData?.length) {
                    event.preventDefault();
                    storeRefs[o][n - 1].innerText = pasteData[0];
                    pasteData.forEach((i, j) => {
                        const nobj = storeRefs[o][n - 1 + j];
                        if (nobj) {
                            nobj.innerText = i.replace(/(['"])(.*?)\1/g, '$2').trim();
                        }
                    });
                    store();
                }
            };

            inputElement.addEventListener('paste', (event) => pasteNameImport(o, n, event));

            inputElement.focus();

        };

        const download = () => {
            let data = localStorage.getItem('data');

            if (data) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
                const dlAnchorElem = document.createElement('a');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", "seatingchart.json");
                document.body.appendChild(dlAnchorElem);
                dlAnchorElem.click();
                document.body.removeChild(dlAnchorElem);
            }
        };

        const uploadData = () => {
            if (refs.uploadfile.value) {
                refs.uploadfile.value.click();
            }
        };

        const randomPos = () => {
            let rNum, i, studentNums;
            // Ensure namelist is not empty and has valid elements
            for (i = storeRefs.totalNamelist.value; i > 0; i--) {
                if (
                    storeRefs.namelist[i - 1] &&
                    typeof storeRefs.namelist[i - 1].innerText === 'string' &&
                    storeRefs.namelist[i - 1].innerText.trim().length
                ) break;
            }

            if (i <= window.randomNumbers.length) return;

            studentNums = Array.from({length: i}, (_, index) => 1 + index);
            if (window.randomNumbers.length)
                studentNums = studentNums.filter(num => !window.randomNumbers.includes(num));

            const posdatas = storeRefs.posdata.slice().reverse();
            for (let j = 0; j < posdatas.length; j++) {
                if (!posdatas[j].innerText.length) {
                    rNum = Math.floor(Math.random() * studentNums.length);
                    // Check for valid index and valid namelist entry
                    if (
                        storeRefs.namelist[studentNums[rNum] - 1] &&
                        typeof storeRefs.namelist[studentNums[rNum] - 1].innerText === 'string' &&
                        storeRefs.namelist[studentNums[rNum] - 1].innerText.trim().length
                    ) {
                        posdatas[j].innerText = String(studentNums[rNum]).padStart(2, '0');
                    } else {
                        j--;
                    }

                    studentNums.splice(studentNums.indexOf(studentNums[rNum]), 1);
                    if (!studentNums.length) break;
                }
            }

            store();
            refs.clearBtnCtl.value = !randomNumbers.length;
        };

        const uploadfileChange = () => {
            const fileInput = refs.uploadfile.value;
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return;
            const reader = new FileReader();
            reader.readAsText(fileInput.files[0], "UTF-8");
            reader.onload = (evt) => {
                localStorage.setItem('data', evt.target.result);
                location.reload();
            }
        };

        const showPos = (n, show) => {
            const seatNumber = String(n).padStart(2, '0');
            refs.highlightedPos.value = show ? seatNumber : null;
        };

        const dragStart = (index, type, event) => {
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: type, index: index }));
            event.target.classList.add('dragging', `${type}-row`);
        };

        const drop = (targetIndex, event) => {
            event.preventDefault();
            const data = JSON.parse(event.dataTransfer.getData('text/plain') || '{}');
            const targetNum = event.currentTarget.classList.contains('leader-row') ? parseInt(storeRefs.leaders[targetIndex]?.innerText || '') : parseInt(storeRefs.posdata[targetIndex]?.innerText || '');
            const sourceIndex = parseInt(data.index);

            if (data.type === 'student' && event.currentTarget.classList.contains('seat-row')) {
                if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                if (window.randomNumbers.includes(sourceIndex)) {
                    alert($gettext('Seat assigned'));
                    return;
                }
                if (targetNum) {
                    window.randomNumbers = window.randomNumbers.filter(num => num !== targetNum);
                    refs.nameBgCtl[targetNum - 1].checked = false;
                }
                if (storeRefs.posdata[targetIndex]) {
                    storeRefs.posdata[targetIndex].innerText = String(sourceIndex).padStart(2, '0');
                    !window.randomNumbers.includes(sourceIndex) && window.randomNumbers.push(sourceIndex);
                    refs.nameBgCtl[sourceIndex - 1].checked = true;
                }
            } else if (data.type === 'seat' && event.currentTarget.classList.contains('seat-row')) {
                if (sourceIndex === targetIndex) return;
                const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                if (storeRefs.posdata[sourceIndex]) {
                    storeRefs.posdata[sourceIndex].innerText = targetNum ? String(targetNum).padStart(2, '0') : '';
                }
                if (storeRefs.posdata[targetIndex]) {
                    storeRefs.posdata[targetIndex].innerText = sourceNum ? String(sourceNum).padStart(2, '0') : '';
                }
                if (sourceNum && !window.randomNumbers.includes(sourceNum)) window.randomNumbers.push(sourceNum);
                if (targetNum && !window.randomNumbers.includes(targetNum)) window.randomNumbers.push(targetNum);
                if (!sourceNum || !targetNum) {
                    window.randomNumbers = window.randomNumbers.filter(num => storeRefs.posdata.some(el => parseInt(el.innerText || '') === num));
                }
                if (sourceNum) refs.nameBgCtl[sourceNum - 1].checked = true;
                if (targetNum) refs.nameBgCtl[targetNum - 1].checked = true;
            } else if (data.type == 'seat' && event.currentTarget.classList.contains('leader-row')) {
                if (sourceIndex === targetIndex) return;
                const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                if (storeRefs.leaders[targetIndex]) {
                    storeRefs.leaders[targetIndex].innerText = sourceNum ? String(sourceNum).padStart(2, '0') : '';
                }
            } else if (data.type === 'leader' && event.currentTarget.classList.contains('leader-row')) {
                if (sourceIndex === targetIndex) return;
                const sourceNum = parseInt(storeRefs.leaders[sourceIndex]?.innerText || '');
                if (storeRefs.leaders[sourceIndex]) {
                    storeRefs.leaders[sourceIndex].innerText = targetNum ? String(targetNum).padStart(2, '0') : '';
                    if (storeRefs.leaders[sourceIndex].innerText == '') {
                        refs.leadersname[sourceIndex].innerHTML = '&nbsp;';
                    }
                }
                if (storeRefs.leaders[targetIndex]) {
                    storeRefs.leaders[targetIndex].innerText = sourceNum ? String(sourceNum).padStart(2, '0') : '';
                }
            } else if (data.type == 'student' && event.currentTarget.classList.contains('leader-row')) {
                if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                if (storeRefs.leaders[targetIndex]) {
                    storeRefs.leaders[targetIndex].innerText = String(sourceIndex).padStart(2, '0');
                }
            }

            document.querySelectorAll('.seat-container').forEach(el => el.classList.remove('dragging'));
            store();
            updatedisplay();
        };

        const toggleColor = (event) => {
            const colors = ['color-0', 'color-1', 'color-2'];
            const el = event.currentTarget;
            let currentIndex = colors.findIndex(c => el.classList.contains(c));
            if (currentIndex === -1) {
                el.classList.add(colors[0]);
                return;
            }
            el.classList.remove(colors[currentIndex]);
            if (currentIndex === colors.length - 1) {
                return;
            }
            el.classList.add(colors[currentIndex + 1]);
        };

        const storeRefs = {
            tabletitle: ref($gettext('Seats charts')),
            today: ref(new Date().toLocaleDateString()),
            totalX: ref(6),
            totalY: ref(8),
            totalNamelist: ref(6 * 8),
            totalLeader: ref(8),
            namelist: reactive([]),
            posdata: reactive([]),
            teacher: ref(null),
            leadernames: reactive([]),
            leaders: reactive([]),
            deskname: ref($gettext('Desk')),
            updateLabel: ref($gettext('Update')),
            teacherLabel: ref($gettext('Teacher')),
            studentListLabel: ref($gettext('Lists'))
        };

        watch(storeRefs.totalX, async(i) => {
            if (i > 6) {
                refs.xColClass.value = 'col-lg-12 col-md-12';
                refs.xColClassStart.value = 'col-1';
                refs.xColClassCenter.value = 'col-10';
                refs.xColClassEnd.value = 'col-1';
            } else {
                refs.xColClass.value = 'col-lg-8';
                refs.xColClassStart.value = 'col-2 col-md-2';
                refs.xColClassCenter.value = 'col-7';
                refs.xColClassEnd.value = 'col-2';
            }
        });

        const refs = {
            uploadfile: ref(null),
            storeData: ref(0),
            xColClass: ref('col-xl-7 col-md-12'),
            xColClassStart: ref('col-2 col-md-2'),
            xColClassCenter: ref('col-6'),
            xColClassEnd: ref('col-2'),
            posname: reactive([]),
            posindex: ref(0),
            leadersname: reactive([]),
            clearBtnCtl: ref(0),
            isDataChanged: ref(0),
            namesBgCtl: ref(0),
            nameBgCtl: reactive([]),
            hideTips: ref(false),
            highlightedPos: ref(null)
        };

        return {
            ...storeRefs,
            ...refs,
            clickToEdit,
            store,
            clearStore,
            download,
            uploadData,
            randomPos,
            clearPos,
            uploadfileChange,
            updatedisplay,
            tipsToHide,
            getCookie,
            showPos,
            dragStart,
            drop,
            toggleColor
        };
    },
    beforeCreate() {
        window.data = localStorage.getItem('data');
        if (window.data) {
            window.data = JSON.parse(window.data);
            window.dkeys = Object.keys(window.data);
            window.dkeys.forEach((i) => {
                if ('tabletitle' == i)
                    document.title = window.data[i];
                else if ('today' == i)
                    this.today = window.data[i];
                else if ('totalNamelist' == i)
                    this.totalNamelist = parseInt(window.data[i]);
                else if ('totalX' == i)
                    this.totalX = parseInt(window.data[i]);
                else if ('totalY' == i)
                    this.totalY = parseInt(window.data[i]);
                else if ('totalLeader' == i)
                    this.totalLeader = parseInt(window.data[i]);

            });
        }
        this.hideTips = this.getCookie('hideTips') == 1;

    },
    mounted() {

        if (document.title == 'Loading') document.title = $gettext('Seats charts');

        if (this.leadernames) {
            if (this.leadernames[0] && !this.leadernames[0].innerText.length) this.leadernames[0].innerText = $gettext('Class president');
            if (this.leadernames[1] && !this.leadernames[1].innerText.length) this.leadernames[1].innerText = $gettext('Vice class president');
        }
        const data = window.data;
        const dkeys = window.dkeys;
        if (data) {
            dkeys.forEach((i) => {
                if (Array.isArray(data[i]) && data[i][0] != null) {
                    data[i].forEach((_, j) => {
                        if (this[i] && undefined != this[i][j]?.innerText)
                            this[i][j].innerText = data[i][j];
                    });
                } else if (undefined != this[i]?.innerText)
                    this[i].innerText = data[i];
                else if (undefined != this[i]?.value)
                    this[i].value = data[i];

            });

            this.updatedisplay();
            this.storeData = 1;
            this.clearBtnCtl = !window.randomNumbers.length;
        }
    }

});

const vue3gettext = createGettext({
    availableLanguages: {
        en: "English",
        zh_TW: "Chinese"
    },
    silent: true,
    defaultLanguage: navigator.language.replace(/-/, '_'),
    translations: {
        "zh_TW": {
            "Seat assigned": "å·²æ’ä½å­",
            "Are you sure you want to clear all entered data?": "ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨è¼¸å…¥çš„è³‡æ–™å—?",
            "Are you sure you want to clear your current seating arrangement?": "ç¢ºå®šè¦æ¸…é™¤ç›®å‰çš„åº§ä½æ’åˆ—å—?",
            "Class president": "ç­é•·",
            "Clear data": "æ¸…é™¤è³‡æ–™",
            "Desk": "è¬›æ¡Œ",
            "Download data": "ä¸‹è¼‰è³‡æ–™",
            "Not enough seats!": "åº§ä½æ•¸ä¸å¤ å!",
            "Number of columns": "æ’æ•¸",
            "Number of leaders": "è‚¡é•·æ•¸",
            "Number of seats": "åº§ä½æ•¸",
            "Number of rows": "åˆ—æ•¸",
            "Please directly click on the name or seat number area to enter information": "è«‹ç›´æ¥é»é¸å§“åæˆ–åº§è™Ÿå€åŸŸè¼¸å…¥è³‡æ–™",
            "Random seats": "éš¨æ©Ÿåº§ä½",
            "Reset seats": "é‡ç½®åº§ä½",
            "Seats charts": "åº§ä½è¡¨",
            "Lists": "åå–®",
            "Teacher": "å°å¸«",
            "Update": "æ›´æ–°æ—¥æœŸ",
            "Upload data": "ä¸Šå‚³è³‡æ–™",
            "Vice class president": "å‰¯ç­é•·"
        }
    }
});

window.$gettext = vue3gettext.$gettext;
app.config.globalProperties.$randomNumbers = window.randomNumbers;
app.use(vue3gettext).mount('#app');

</script>
</body>
</html>

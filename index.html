<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta name="google-site-verification" content="XMksXOyLKjmb5ytHkIccl5eZYVXte1OgEkrzg2UWaKs" />
  <title>TYçš„åº§ä½è¡¨éš¨æ©Ÿç”¢ç”Ÿå™¨ - TY's Seating Chart Generator</title>
  <meta name="description" content="TYçš„åº§ä½è¡¨éš¨æ©Ÿç”¢ç”Ÿå™¨ æä¾›è€å¸«èˆ‡å­¸ç”Ÿå€‘å¯ä»¥å¿«é€Ÿéš¨æ©Ÿç”¢ç”Ÿåº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ä¸¦æä¾›ä¸‹è¼‰çš„åŠŸèƒ½">
  <meta name="keywords" content="å…è²»ç·šä¸Šåº§ä½è¡¨ç”¢ç”Ÿå™¨ åº§ä½è¡¨ç”Ÿæˆå™¨ æ•™å®¤åº§ä½è¡¨ æ›åº§ä½ æ•™å®¤æŠ½ç±¤ éš¨æ©Ÿåº§ä½ åº§ä½è¡¨">
  <meta name="author" content="TYçš„ç”Ÿæ´»è¨˜éŒ„ TY's Life in Taiwan">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="https://ty-seatingchart.pages.dev" />
  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="SeatingChart - æ•™å®¤åº§ä½è¡¨ & Online Student Seating Chart for Teachers">
  <meta property="og:description" content="å¿«é€Ÿç”Ÿæˆæ•™å®¤åº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ã€å®‰æ’ã€æ‹–æ‹‰ã€éš¨æ©Ÿåº§ä½ã€è¡Œåˆ—è‡ªè¨‚ã€è‚¡é•·è¨­å®šä»¥åŠ JSON å‚™ä»½">
  <meta property="og:url" content="https://ty-seatingchart.pages.dev">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://ty-seatingchart.pages.dev/seatingchart.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="628">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SeatingChart - æ•™å®¤åº§ä½è¡¨ & Teacher-Friendly Online Student Seating Chart">
  <meta name="twitter:description" content="ç®¡ç†å­¸ç”Ÿåº§ä½è¡¨ï¼Œæ”¯æ´å³æ™‚ç·¨è¼¯ã€æ‹–æ‹‰ã€éš¨æ©Ÿåº§ä½ã€è¡Œåˆ—è‡ªè¨‚ã€è‚¡é•·è¨­å®šï¼Œä»¥åŠ JSON/Local Storage å‚™ä»½ã€‚Perfect for teachers.">
<meta name="twitter:image" content="https://ty-seatingchart.pages.dev/seatingchart.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pako/dist/pako.min.js"></script>
<script>
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue")):"function"==typeof define&&define.amd?define(["exports","vue"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VueGettext={},e.Vue)}(this,function(e,t){"use strict";const n=/[[\].]{1,2}/g,a=/%\{((?:.|\n)+?)\}/g,r=/\{\{((?:.|\n)+?)\}\}/g,s=e=>(t,s={},c)=>{!e.silent&&r.test(t)&&console.warn(`Mustache syntax cannot be used with vue-gettext. Please use "%{}" instead of "{{}}" in: ${t}`);const o=t.replace(a,(e,t)=>{const a=t.trim();let r;return function e(t,a,s){try{r=function(e,t){const a=t.split(n).filter(e=>e);for(;a.length;)e=e[a.shift()];return e}(t,a)}catch(e){}if(null==r){if(s)return e(s.ctx,a,s.parent);console.warn(`Cannot evaluate expression: ${a}`),r=a}return r.toString()}(s,a,c)});return o};s.INTERPOLATION_RE=a,s.INTERPOLATION_PREFIX="%{";var c=function(e,t){switch(t="number"==typeof(t=Number(t))&&isNaN(t)?1:t,e.length>2&&"pt_BR"!==e&&(e=e.split("_")[0]),e){case"ay":case"bo":case"cgg":case"dz":case"fa":case"id":case"ja":case"jbo":case"ka":case"kk":case"km":case"ko":case"ky":case"lo":case"ms":case"my":case"sah":case"su":case"th":case"tt":case"ug":case"vi":case"wo":case"zh":return 0;case"is":return t%10!=1||t%100==11?1:0;case"jv":return 0!==t?1:0;case"mk":return 1===t||t%10==1?0:1;case"ach":case"ak":case"am":case"arn":case"br":case"fil":case"fr":case"gun":case"ln":case"mfe":case"mg":case"mi":case"oc":case"pt_BR":case"tg":case"ti":case"tr":case"uz":case"wa":return t>1?1:0;case"lv":return t%10==1&&t%100!=11?0:0!==t?1:2;case"lt":return t%10==1&&t%100!=11?0:t%10>=2&&(t%100<10||t%100>=20)?1:2;case"be":case"bs":case"hr":case"ru":case"sr":case"uk":return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;case"mnk":return 0===t?0:1===t?1:2;case"ro":return 1===t?0:0===t||t%100>0&&t%100<20?1:2;case"pl":case"csb":return 1===t?0:t%10>=2&&t%10<=4&&(t%100<10||t%100>=20)?1:2;case"cs":case"sk":return 1===t?0:t>=2&&t<=4?1:2;case"sl":return t%100==1?0:t%100==2?1:t%100==3||t%100==4?2:3;case"mt":return 1===t?0:0===t||t%100>1&&t%100<11?1:t%100>10&&t%100<20?2:3;case"gd":return 1===t||11===t?0:2===t||12===t?1:t>2&&t<20?2:3;case"cy":return 1===t?0:2===t?1:8!==t&&11!==t?2:3;case"kw":return 1===t?0:2===t?1:3===t?2:3;case"ga":return 1===t?0:2===t?1:t>2&&t<7?2:t>6&&t<11?3:4;case"ar":return 0===t?0:1===t?1:2===t?2:t%100>=3&&t%100<=10?3:t%100>=11?4:5;default:return 1!==t?1:0}};const o=Symbol("GETTEXT");function u(e){return e.replaceAll(/\r?\n/g,"\n")}function i(e){const t={};return Object.keys(e).forEach(n=>{const a=e[n],r={};Object.keys(a).forEach(e=>{r[u(e)]=a[e]}),t[n]=r}),t}const l=e=>({getTranslation:function(t,n=1,a=null,r=null,s,o){void 0===s&&(s=e.current);const i=(t,n)=>n?e.interpolate(t,n):t;if(t=u(t),r=r?u(r):null,!t)return"";const l=!!s&&(e.silent||-1!==e.muted.indexOf(s));let g="en";e.sourceCodeLanguage&&(g=e.sourceCodeLanguage);const f=r&&c(g,n)>0?r:t,p=e.translations,d=p[s]||p[s.split("_")[0]];if(!d)return l||console.warn(`No translations found for ${s}`),i(f,o);const x=()=>{if(!l){let e=`Untranslated ${s} key found: ${t}`;a&&(e+=` (with context: ${a})`),console.warn(e)}return i(f,o)},b=(a,r=null)=>{if(a instanceof Object){if(Array.isArray(a))return(a=>{let r=c(s,n);1===a.length&&1===n&&(r=0);const u=a[r];if(!u){if(""===u)return i(f,o);throw new Error(t+" "+r+" "+e.current+" "+n)}return i(u,o)})(a);const u=a[null!=r?r:""];return b(u)}return r?x():a?i(a,o):x()},h=d[t];return b(h,a)},gettext:function(e,t){return this.getTranslation(e,void 0,void 0,void 0,void 0,t)},pgettext:function(e,t,n){return this.getTranslation(t,1,e,void 0,void 0,n)},ngettext:function(e,t,n,a){return this.getTranslation(e,n,null,t,void 0,a)},npgettext:function(e,t,n,a,r){return this.getTranslation(t,a,e,n,void 0,r)}}),g={availableLanguages:{en:"English"},defaultLanguage:"en",sourceCodeLanguage:void 0,mutedLanguages:[],silent:!1,translations:{},setGlobalProperties:!0,globalProperties:{language:["$language"],gettext:["$gettext"],pgettext:["$pgettext"],ngettext:["$ngettext"],npgettext:["$npgettext"],interpolate:["$gettextInterpolate"]}};e.createGettext=function(e={}){Object.keys(e).forEach(e=>{if(-1===Object.keys(g).indexOf(e))throw new Error(`${e} is an invalid option for the translate plugin.`)});const n={...g,...e},a=t.ref(i(n.translations)),r=t.reactive({available:n.availableLanguages,muted:n.mutedLanguages,silent:n.silent,translations:t.computed({get:()=>a.value,set:e=>{a.value=i(e)}}),current:n.defaultLanguage,sourceCodeLanguage:n.sourceCodeLanguage,install(e){if(e[o]=r,e.provide(o,r),n.setGlobalProperties){const t=e.config.globalProperties;let a=n.globalProperties.gettext||["$gettext"];a.forEach(e=>{t[e]=r.$gettext}),a=n.globalProperties.pgettext||["$pgettext"],a.forEach(e=>{t[e]=r.$pgettext}),a=n.globalProperties.ngettext||["$ngettext"],a.forEach(e=>{t[e]=r.$ngettext}),a=n.globalProperties.npgettext||["$npgettext"],a.forEach(e=>{t[e]=r.$npgettext}),a=n.globalProperties.language||["$language"],a.forEach(e=>{t[e]=r})}}}),c=l(r),u=s(r);return r.$gettext=c.gettext.bind(c),r.$pgettext=c.pgettext.bind(c),r.$ngettext=c.ngettext.bind(c),r.$npgettext=c.npgettext.bind(c),r.interpolate=u.bind(u),r},e.defineGettextConfig=e=>e,e.useGettext=()=>{const e=t.inject(o,null);if(!e)throw new Error("Failed to inject gettext. Make sure vue3-gettext is set up properly.");return e}});
</script>
<style>
[v-cloak] {
    display: none;
}
.seat-container {
    cursor: move;
}
.color-0 { background-color: #fff !important }
.color-1 { background-color: #e0f7fa !important }
.color-2 { background-color: #e8f5e9 !important }
.color-3 { background-color: #fffde7 !important }
.color-4 { background-color: #f3e5f5 !important }
.color-5 { background-color: #fce4ec !important }
.color-6 { background-color: #e3f2fd !important }
.color-7 { background-color: #ede7f6 !important }
.color-8 { background-color: #f9fbe7 !important }
.color-9 { background-color: #fff3e0 !important }
.color-10 { background-color: #efebe9 !important }
.seat-container[draggable="true"]:hover {
    background-color: #f8f9fa;
}
.seat-container.dragging {
    opacity: 0.5;
}
.seat-row {
    outline: 1px solid #dee2e6;
}
.seat-row .namearea {
    min-width: 30px;
    min-height: 100px;
}
.table-cell {
    text-align: center;
    white-space: nowrap;
    padding: 1px;
}
.table {
  table-layout: fixed;
}
.vertical-text {
    -webkit-writing-mode:vertical-lr;
    writing-mode:vertical-lr;
  white-space: normal;
  inline-size: auto;
  block-size: auto;
  min-inline-size: 0;
  min-block-size: 0;
}
.text-justify-last {
  text-align-last: justify;
}
.seats {
    display: flex;
    flex-direction: column;
}
.possize {
    min-width:1.5em;
    min-height:1.5em;
}
.desk {
    border: 1px solid gray;
}
.w-50px {
    width: 50px;
}
.no-border-right {
    border-right: none !important;
}
.no-border-left {
    border-left: none !important;
}
.resize-x {
    resize: horizontal;
    overflow-x: auto;
    overflow-y: hidden;
}
.resize-y {
    resize: vertical;
    overflow-x: hidden;
    overflow-y: auto;
}
.floating-img {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 200px;
  height: auto;
  z-index: 999;
  transition: opacity 0.3s;
}
.close {
  position: absolute;
  top: -10px;
  right: -5px;
  cursor: pointer;
}
.namearea {
    word-break: break-word;
    overflow-wrap: break-word;
}
</style>
<style id="dynamic-zh-font" type="text/css">
.emptycss {
    color: #fff;
}
</style>
</head>
<body class="overflow-x-hidden">
<div id="app" class="w-auto" v-cloak>
    <div class="d-print-none m-1">
        <!-- top area -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" @click="toggleNavBarCtl">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="#" @click="goHome">ğŸ  {{ $gettext("TY's Seating Chart Generator") }}</a>
                <div class="collapse navbar-collapse" :class="{show: toggleNavbar}">
                    <ul class="navbar-nav m-auto">
                        <a class="nav-link text-center">{{ $gettext('Columns') }}: <input type="number" class="w-50px" v-model="totalX" min="1" ref="totalxs" @change="store" @focus="$event.target.select()"></a>
                        <a class="nav-link text-center">{{ $gettext('Rows') }}: <input type="number" class="w-50px" v-model="totalY" min="1" ref="totalys" @change="store" @focus="$event.target.select()"></a>
                        <a class="nav-link text-center">{{ $gettext('Seats') }}: <input type="number" class="w-50px" min="1" ref="totalnums" @change="store" :value="totalX * totalY" :disabled="true"></a>
                        <li class="nav-item dropdown position-relative text-center">
                            <button class="form-control-sm btn-outline-secondary dropdown-toggle" type="button" @click="toggleSubmenu = !toggleSubmenu">{{ $gettext('Methods') }}</button>
                            <ul class="dropdown-menu show" v-if="toggleSubmenu">
                                <li v-if="storeData"><button class="dropdown-item" type="button" @click="clearStore">{{ $gettext('Clear') }}</button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li v-if="storeData"><button class="dropdown-item" type="button" @click="download">{{ $gettext('Download') }}</button></li>
                                <li><button class="dropdown-item" type="button" onclick="uploadfile.click()">{{ $gettext('Upload') }}</button></li>
                                <li><button class="dropdown-item" type="button" @click="randomPos">{{ $gettext('Random') }}</button></li>
                                <li><button class="dropdown-item" type="button" :disabled="clearBtnCtl" @click="resetPos">{{ $gettext('Reset') }}</button></li>
                                <li><button class="dropdown-item" type="button" onclick="window.print()">{{ $gettext('Print') }}</button></li>
                                <li><button class="dropdown-item" type="button" @click="shareData">{{ $gettext('Share') }}</button></li>
                            </ul>
                        </li>
                        <input id="uploadfile" type="file" @change="uploadfileChange($event)" class="visually-hidden" accept="application/json">
                        <div class="navbar-nav h-100">
                            <button class="form-control-sm" :title="$gettext('Font size')" @click="adujstFont('+')">+</button>
                            <select class="text-center form-control-sm" v-model="fontPos"><option value="l">{{ $gettext('Left') }}</option><option value="c">{{ $gettext('Center') }}</option><option value="r">{{ $gettext('Right') }}</option></select>
                            <button class="form-control-sm" :title="$gettext('Font size')" @click="adujstFont('-')" :disabled="fontButtonCtl">-</button>
                        </div>
                        <div class="text-center">
                            <button class="form-control-sm btn-outline-secondary dropdown-toggle" type="button" @click="toggleOptionmenu = !toggleOptionmenu">{{ $gettext('Options') }}</button>
                            <div class="dropdown-menu form-switch show" v-if="toggleOptionmenu">
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showList">&nbsp;{{ $gettext('Lists') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showSeats">&nbsp;{{ $gettext('Seats') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showNumber" :disabled="!showSeats">&nbsp;{{ $gettext('Numbers') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showPlace" :disabled="!showSeats">&nbsp;{{ $gettext('Place') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showName" :disabled="!showSeats">&nbsp;{{ $gettext('Names') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showVertical" :disabled="!showSeats">&nbsp;{{ $gettext('Vertical') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showLeader">&nbsp;{{ $gettext('Leaders') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showNote">&nbsp;{{ $gettext('Note') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="speechVoice">&nbsp;{{ $gettext('Voice') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showDate">&nbsp;{{ $gettext('Date') }}</label>
                                <label class="nav-link form-switch text-center"><input type="checkbox" class="form-check-input" v-model="showDesk">&nbsp;{{ $gettext('Desk') }}</label>
                            </div>
                        </div>
                        <select class="text-center h-100 form-control-sm" v-model="showFonts"><option value="">{{ $gettext('Fonts') }}</option><option value="zhuyin">{{ $gettext('ZhuYin') }}</option><option value="pinyin">{{ $gettext('PinYin') }}</option><option value="bothfonts">{{ $gettext('Both') }}</option></select>
                        <button class="form-control-sm h-100" @click="binGo" :disabled="bingoButtonCtl">{{ $gettext('Bingo') }}</button>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="alert alert-primary p-1 m-auto text-center" @click="tipsToHide" v-show="!hideTips">{{ $gettext('Please directly click on the name or seat number area to enter information') }}</div>
        <div class="row justify-content-center m-2">
            <a class="col-auto seat-container p-2 mx-1" v-for="(color, i) in colors" :class="[color, {'border': i == 0, 'border border-primary': colorIndex == i}]" style="cursor:pointer" @click="colorIndex = i"><span class="visually-hidden"></span></a>
        </div>
    </div>
    <div class="container-fluid row mx-auto" :style="{'font-size': fontSizeR + 'em'}">
        <div class="col-sm-3"></div>
        <div class="text-nowrap text-center col-sm-6" @click="startEdit($event.target)" @blur="endEdit" ref="tabletitle">{{ $gettext('Seating charts') }}</div>
        <div class="text-nowrap text-end col-sm-3" :class="{'d-none': !showDate}"><span @click="startEdit($event.target)" @blur="endEdit" ref="updateLabel">{{ $gettext('Date') }}:</span><span class="ps-2" @click="startEdit($event.target)" @blur="endEdit('today')" ref="today"></span></div>
    </div>

    <div class="container-fluid row mx-auto">
        <div class="col-lg-2 col-md-2 col-sm-2 pt-1 table-responsive overflow-x-hidden resize-y" v-show="showList">
            <!-- left area -->
            <table class="table table-bordered table-striped small">
                <thead>
                    <tr class="border-secondary small">
                        <th class="ps-3 py-1 no-border-right" style="min-width:25%">
                            <input class="form-check-input d-print-none" type="checkbox" ref="nameBtnCtl" @change="nameBtnCtlChange($event)">
                        </th>
                        <th class="text-nowrap py-1 no-border-left w-75" :style="{'font-size': fontSizeL + 'em'}" @click="startEdit($event.target)" @blur="endEdit" ref="studentListLabel">
                            {{ $gettext('Lists') }}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="seat-container namelist-row" v-for="n in totalNamelist" @mouseover="showPhoto(n)" @mouseout="photo = ''" :class="{'border-secondary': n % 5 == 0}" :style="{'font-size': fontSizeL + 'em'}" draggable="true" @dragstart="dragStart(n, 'student')" @dragover.prevent @drop="drop(n)">
                        <td class="text-nowrap no-border-right p-1" :class="{'border-start': n % 5 == 0}">
                            <label class="d-flex w-100"><input class="form-check-input d-print-none" type="checkbox" @click="doSpeak(n)" @focus="showPos(n, 1)" @keydown="editKeydown('nameBgCtl', n)" ref="nameBgCtl" v-model="nameBgCtlChecked" :value="n">
                            <span class="d-none d-print-block px-1">{{nameBgCtl[n - 1]?.checked ? 'âœ“' : 'â˜'}}</span><span class="d-flex justify-content-end" style="min-width:20px">{{ n }}</span></label>
                        </td>
                        <td class="no-border-left py-1 namearea text-truncate" :class="{'border-end': n % 5 == 0}" @focus="showPos(n, 1)" @paste="editPaste('namelist', n)" @keydown="editKeydown('namelist', n)" @click="startEdit($event.target);toggleColor($event)" @blur="endEdit" ref="namelist" @mouseover="setTitle($event)"></td>
                    </tr>
                </tbody>
            </table>

        </div>
        <div class="bg-white seats px-0" :class="{'col-lg-8 col-md-7 col-sm-7': showList && (showLeader || showNote), 'col-lg-10 col-md-10 col-sm-10': showList && !(showLeader || showNote), 'col-lg-10 col-md-9 col-sm-9': !showList && (showLeader || showNote), 'col-lg-12 col-md-12 col-sm-12': !showList && !(showLeader || showNote)}" :style="{'font-size': fontSizeC + 'em'}" v-show="showSeats">
            <!-- center area -->
            <div class="row g-1" v-for="y in totalY" :key="'row' + y + 'x' + totalX">
                <div class="col py-1" v-for="x in totalX" :key="'seat' + y + '-' + x">
                    <div class="p-0 seat-row seat-container h-100 d-flex flex-column justify-content-be-tween" :class="{'bg-info': highlightedPos && posdata[(y-1)*totalX + x-1]?.innerText == highlightedPos}" @click="toggleColor" draggable="true" @dragstart="dragStart(((y-1)*totalX + x-1), 'seat')" @dragover.prevent @drop="drop(((y-1)*totalX + x-1))">
                        <div class="border-bottom text-center p-0 bg-light possize" :class="{'d-none': !showNumber}" @paste="editPaste('posdata', ((y-1)*totalX + x-1))" @keydown="editKeydown('posdata', ((y-1)*totalX + x-1))" @click.stop="startEdit($event.target)" @blur="endEdit('posdata', $event.target.innerText, ((y-1)*totalX + x-1))" ref="posdata"></div>
                        <div class="fs-6 text-light text-end p-0" :class="{'d-none': !showPlace}">{{ `${x}-${totalY - y + 1}` }}</div>
                        <div class="p-0 text-center mx-auto namearea d-flex align-items-center justify-content-center" :class="{'d-none': !showName,'mb-2': showVertical, 'mb-3': !showVertical, 'vertical-text': showVertical, 'border border-secondary': posNameHovered == ((y-1)*totalX + x-1) && posname[(y-1)*totalX + x-1].innerText == ''}" @click.stop="startEdit($event.target)" @mouseover="posNameHovered=((y-1)*totalX + x-1)" ref="posname">&nbsp;</div>
                    </div>
                </div>
            </div>
            <div class="row mx-auto m-2 resize-x" :class="{'d-none': !showDesk}" :style="{'font-size': fontSizeR + 'em'}">
                <div class="mx-auto text-center desk" @click="startEdit($event.target)" @blur="endEdit" ref="deskname">{{ $gettext('Desk') }}</div>
            </div>
        </div>
        <div class="col-lg-2 col-md-3 col-sm-3 pt-1">
            <!-- right area -->
            <table class="table table-bordered table-striped" :style="{'font-size': fontSizeR + 'em'}" :class="{'d-none': !showLeader}">
                <colgroup>
                    <col style="width: 30%">
                </colgroup>
                <thead>
                <tr>
                    <th scope="row" colspan="2" class="text-justify-last bg-light" @click="startEdit($event.target)" @blur="endEdit" ref="teacherLabel">{{ $gettext('Teacher') }}</th>
                </tr>
                <tr>
                    <td colspan="2" class="text-center ps-0 pe-0 text-nowrap namearea" :style="{'height': fontSizeR * 2 + 'em'}" @click="startEdit($event.target)" @blur="endEdit" ref="teacher"></td>
                </tr>
                </thead>
                <tbody v-for="(n, index) in totalLeader">
                    <tr class="leader-row" @drop="drop(index)">
                        <th scope="row" class="text-end text-nowrap text-justify-last" :style="{'height': fontSizeR * 2 + 'em'}" colspan="2" @click="startEdit($event.target)" @blur="endEdit" @keydown="editKeydown('leadernames', n)" @paste="editPaste('leadernames', n)" ref="leadernames"></th>
                    </tr>
                    <tr class="leader-row" :style="{'height': fontSizeR * 2 + 'em'}" @mouseover="showPos(leaders[n - 1].innerText, 1)" @mouseout="showPos(leaders[n - 1]?.innerText, 0)" draggable="true" @dragstart="dragStart(index, 'leader')" @dragover.prevent @drop="drop(index)">
                        <td class="seat-container" :class="{'d-none': !showNumber, 'text-end no-border-right': showName, 'text-center': !showName}" @click="startEdit($event.target)" :colspan="!showName ? 2 : 0" @keydown="editKeydown('leaders', n)" @blur="endEdit('leaders', $event.target.innerText, n)" @paste="editPaste('leaders', n)" ref="leaders"></td>
                        <td class="seat-container text-nowrap namearea no-border-left" :class="{'text-center': !showNumber, 'd-none': !showName}" :colspan="!showNumber ? 2 : 0" @click="startEdit($event.target)" ref="leadersname"></td>
                    </tr>
                </tbody>
            </table>
            <div class="card" :class="{'d-none': !showNote}">
                <div class="card-header namearea" :style="{'font-size': fontSizeR + 'em'}" @click="startEdit($event.target)" @blur="endEdit" ref="noteLabel">{{ $gettext('Note') }}</div>
                <div class="card-body namearea" :style="{'font-size': fontSizeR + 'em', 'min-height': fontSizeR * 2 + 'em'}" @click="startEdit($event.target)" @blur="endEdit" ref="note"></div>
            </div>
        </div>
    </div>

    <div v-if="photo" @click="photo=null" class="floating-img card p-0 m-0"><span class="close">âœ•</span><div class="fs-6 text-end pe-2">&nbsp;<span :class="{'d-none': !showPlace}">{{ seatsPos }}</span></div><img :src="photo" alt="" /><p class="text-center namearea"><span :class="{'d-none': !showNumber}">{{photoNo}}&nbsp;</span><span :class="{'d-none': !showName}">{{ photoName }}</span></p></div>
    <div v-if="!photo && doBingo" @click="doBingo = false" class="floating-img card p-3 m-2 border-primary" :class="{'bg-info': !bingoButtonCtl}"><span class="close">âœ•</span><div class="fs-6 text-end pe-2">&nbsp;<span :class="{'d-none': !showPlace}">{{ seatsPos }}</span></div><p class="text-center namearea"><span :class="{'d-none': !showNumber}">{{photoNo}}&nbsp;</span><span :class="{'d-none': !showName}">{{ photoName }}</span></p></div>

    <footer class="d-print-none text-end">
        <noscript>
            <h1>TY åº§ä½è¡¨éš¨æ©Ÿç”¢ç”Ÿå™¨ - çœŸå¿ƒæ¨è–¦çš„ç·šä¸Šå…è²»æ’åº§ä½å·¥å…·</h1>
            <p>æ­¡è¿ä½¿ç”¨ TY's Seating Chart Generatorã€‚é€™æ˜¯ä¸€æ¬¾å°ˆç‚ºè€å¸«ã€ç­ç´šå¹¹éƒ¨è¨­è¨ˆçš„<b>ç·šä¸Šåº§ä½è¡¨å·¥å…·</b>ï¼Œæ¯” Wordã€Excel æ›´è¼•é¬†ï¼Œæ—¨åœ¨è§£æ±ºæ›åº§ä½ã€æ’åº§ä½çš„ç…©æƒ±ã€‚é€éé€™å€‹<b>åº§ä½è¡¨ç”¢ç”Ÿå™¨</b>ï¼Œæ‚¨å¯ä»¥è¼•é¬†å®Œæˆ<b>éš¨æ©Ÿæ’åº§ä½</b>èˆ‡é…ç½®èª¿æ•´ã€‚</p>
            <h2>æ ¸å¿ƒåŠŸèƒ½ä»‹ç´¹ï¼š</h2>
            <ul>
                <li><b>ç·šä¸Šåº§ä½è¡¨ç”¢ç”Ÿå™¨ï¼š</b>å…ä¸‹è¼‰ã€å…å®‰è£ï¼Œé–‹å•Ÿç¶²åŸŸå³å¯ä½¿ç”¨ï¼Œé›»è…¦æ‰‹æ©Ÿçš†å¯æ“ä½œã€‚</li>
                <li><b>éš¨æ©Ÿæ’åº§ä½ï¼š</b>å…§å»ºæ¼”ç®—æ³•ä¸€éµè‡ªå‹•æ’åˆ—å­¸ç”Ÿåå–®ï¼Œå…¬å¹³ã€é€æ˜ã€å¿«é€Ÿã€‚</li>
                <li><b>å­¸ç”Ÿåå–®å¿«é€ŸåŒ¯å…¥ï¼š</b>æ”¯æ´ç›´æ¥è²¼ä¸Šåå–®ï¼Œä¸ç”¨ä¸€å€‹ä¸€å€‹æ‰‹æ‰“ï¼Œçœä¸‹å¤§é‡è¡Œæ”¿æ™‚é–“ã€‚</li>
                <li><b>è‡ªå®šç¾©æ•™å®¤é…ç½®ï¼š</b>éˆæ´»èª¿æ•´æ¬„ä½èˆ‡æ’æ•¸ï¼Œé©æ‡‰å„ç¨®è¦æ¨¡çš„æ•™å®¤å¤§å°ã€‚</li>
                <li><b>ä¸€éµåˆ—å°èˆ‡åŒ¯å‡ºï¼š</b>æ’å¥½å¾Œæ”¯æ´ç›´æ¥åˆ—å°ï¼Œæ–¹ä¾¿è€å¸«å°‡åº§ä½è¡¨å¼µè²¼æ–¼ç­ç´šä½ˆå‘Šæ¬„ã€‚</li>
                <li><b>é–‹æºå°ˆæ¡ˆï¼š</b>æœ¬å·¥å…·ç‚ºé–‹æ”¾åŸå§‹ç¢¼å°ˆæ¡ˆï¼Œå®‰å…¨ä¸”æŒçºŒç¶­è­·ã€‚</li>
            </ul>
            <p>é€™æ˜¯ä¸€å€‹ç”±é–‹ç™¼è€…ç¨ç«‹ç¶­è­·çš„ Side Project ï¼Œè‡´åŠ›æ–¼æä¾›æœ€ç°¡ä¾¿ã€æœ‰æ•ˆç‡ä¸”å®Œå…¨å…è²»çš„ç·šä¸Šæ’åº§ä½å·¥å…·ã€‚</p>
        </noscript>
        <a href="https://github.com/tyroneyeh/SeatingChart/" target="_blank">
            <img src="https://img.shields.io/github/last-commit/tyroneyeh/SeatingChart" alt="GitHub last commit" />
            <img src="https://data.jsdelivr.com/v1/package/gh/tyroneyeh/SeatingChart/badge?style=rounded" alt="JSDelivr CDN" />
        </a>
    </footer>
</div>

<script>
'use strict';

function goHome() {
    location.href = location.origin;
}

function setFonts(newVal) {
    const el = document.getElementById('dynamic-zh-font');
    const fonts = {
        zhuyin: {
            family: 'BpmfZihiKai',
            file: 'https://gcore.jsdelivr.net/gh/ButTaiwan/bpmfvs/outputs/BpmfZihiKaiStd-Regular.ttf',
            type: 'truetype'
        },
        pinyin: {
            family: 'Pinyin-Tsuipita',
            file: 'https://ty-seatingchart.pages.dev/ToneOZ-Pinyin-Tsuipita-TC.woff2',
            type: 'woff2'
        },
        bothfonts: {
            family: 'YinPZ-Tsuipita',
            file: 'https://ty-seatingchart.pages.dev/ToneOZ-YinPZ-Tsuipita-TC.woff2',
            type: 'woff2'
        }
    };
    const f = fonts[newVal];
    if (f) {
        el.innerHTML = `@font-face {font-family: '${f.family}';src: url('${f.file}') format('${f.type}');font-weight: normal;font-style: normal;}.namearea {font-family: '${f.family}';}`;
        localStorage.setItem('showFonts', newVal);
    } else {
        el.innerHTML = '';
        localStorage.removeItem('showFonts');
    }
    return newVal;
}

function toBase64Url(u8) {
  let s = "";
  for (const element of u8) s += String.fromCodePoint(element);
  return btoa(s).replaceAll('+', "-").replaceAll('/', "_").replace(/=+$/g, "");
}

function fromBase64Url(b64url) {
  let b64 = b64url.replaceAll('-', '+').replaceAll('_', '/');
  while (b64.length % 4) b64 += "=";
  const bin = atob(b64);
  const u8 = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) u8[i] = bin.codePointAt(i);
  return u8;
}

function gzipBase64UrlBC(obj) {
  return toBase64Url(pako.gzip(JSON.stringify(obj)));
}

function ungzipBase64UrlBC(token) {
  const u8 = fromBase64Url(token);
  return pako.ungzip(u8, {to: "string"});
}

const IDBHelper = {
    db: null,

    async init(dbName, version, storeName) {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, version);

            request.onupgradeneeded = event => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName);
                }
            };

            request.onsuccess = event => {
                this.db = event.target.result;
                resolve(this.db);
            };
        });
    },

    async put(storeName, value, key) {
        if (!this.db) await this.init('photo', 1, storeName);

        return new Promise((resolve, reject) => {
            const tx = this.db.transaction([storeName], 'readwrite');
            const store = tx.objectStore(storeName);
            const req = key ? store.put(value, key) : store.put(value);
            req.onsuccess = () => resolve(req.result);
        });
    },

    async get(storeName, key) {
        if (!this.db) await this.init('photo', 1, storeName);

        return new Promise((resolve, reject) => {
            const tx = this.db.transaction([storeName], 'readonly');
            const store = tx.objectStore(storeName);
            let req;
            if (key) {
                req = store.get(key);
                req.onsuccess = () => resolve(req.result)
            } else {
                req = [];
                store.openCursor().onsuccess = event => {
                    const cursor = event.target.result;
                    if (cursor) {
                        req.push({[cursor.key]: cursor.value});
                        cursor.continue();
                    } else {
                        resolve(req);
                    }
                };
            }
        });
    },
    async remove(dbName) {
        return indexedDB.deleteDatabase(dbName);
    }
};

const { createApp, ref, reactive, computed, nextTick } = Vue;
const app = createApp({
    beforeCreate() {
        const params = new URLSearchParams(location.hash.substring(1));
        if (params.has('data')) {
            globalThis.jsondata = ungzipBase64UrlBC(params.get('data'));
        } else {
            globalThis.jsondata = localStorage.getItem('data');
        }

        if (globalThis.jsondata) {
            try {
                const data = JSON.parse(globalThis.jsondata);

                const typeMap = {
                    totalNamelist: Number,
                    totalX: Number,
                    totalY: Number,
                    totalLeader: Number,
                    fontSizeR: parseFloat,
                    fontSizeC: parseFloat,
                    fontSizeL: parseFloat
                };

                globalThis.dkeys = Object.entries(data);

                for (const [key, value] of globalThis.dkeys) {
                    if (key == 'tabletitle') {
                        document.title = value;
                    } else if (key == 'today') {
                        this.today = value;
                    } else if (key in typeMap) {
                        this[key] = typeMap[key](value);
                    }
                }
            } catch (e) {
                console.error(e);
            }

        }
        this.hideTips = this.getCookie('hideTips') == 1;
    },
    setup() {

        let oldValue;

        const getCookie = name => {
            let value = '; ' + document.cookie;
            let parts = value.split(`; ${name}=`);
            if (parts.length == 2) return parts.pop().split(';').shift();
        };

        const setCookie = (name, value, age) => {
            age = undefined == age ? 60 * 60 * 24 * 14 : age;
            document.cookie = `${name}=${value}; path=${location.pathname}; max-age=${age};`;
        };

        const removeCookie = (name, value) => {
            setCookie(name, value, 0);
        };

        function toggleNavBarCtl() {
            refs.toggleNavbar.value = !refs.toggleNavbar.value;
            refs.toggleNavbar.value ? localStorage.setItem('toggleNavbar', 1) : localStorage.removeItem('toggleNavbar');
        }

        const tipsToHide = () => {
            refs.hideTips.value = true;
            setCookie('hideTips', 1);
        };

        function getNameByNumber(num) {
            const nameListEntry = storeRefs.namelist?.[num - 1];
            return nameListEntry ? nameListEntry.innerHTML : "";
        }

        function setNameText(targetArr, index, num) {
            const name = getNameByNumber(num);
            targetArr[index].innerHTML = name;
        }

        const updateDisplay = (o, num, pos) => {
            if (storeRefs.totalX.value > 1 && storeRefs.totalY.value > 1) {
                refs.totalnums.value = storeRefs.totalX.value * storeRefs.totalY.value;
            }

            refs.clearBtnCtl.value = storeRefs.posdata.every(i => i.innerText.trim() == "");

            if (o == 'posdata' && num) {
                setNameText(refs.posname, pos, num);
                const ctl = refs.nameBgCtl[parseInt(num) - 1];
                if (ctl) ctl.checked = true;
            } else if (o == 'leaders' && num) {
                setNameText(refs.leadersname, pos - 1, num);
            } else if (!o) {
                storeRefs.posdata.forEach((item, j) => {
                    refs.posname[j].innerText = '';
                    const sNum = parseInt(item.innerText.trim());
                    if (!isNaN(sNum)) {
                        setNameText(refs.posname, j, sNum);
                        const ctl = refs.nameBgCtl[parseInt(sNum) - 1];
                        if (ctl) ctl.checked = true;
                    }
                });

                storeRefs.leaders.forEach((item, j) => {
                    const sNum = parseInt(item.innerText.trim());
                    if (!isNaN(sNum)) {
                        setNameText(refs.leadersname, j, sNum);
                    }
                });

            }
        };


        const store = (o) => {

            const datakeys = Object.keys(storeRefs);

            if (!storeRefs.namelist.filter(i => i.innerText.trim().length).length && storeRefs.totalX.value > 1 && storeRefs.totalY.value > 1) storeRefs.totalNamelist.value = storeRefs.totalX.value * storeRefs.totalY.value;

            if (o !== 'today') storeRefs.today.value.innerText = new Date().toLocaleDateString();

            const dataToSave = {};

            datakeys.forEach(key => {
                const ref = storeRefs[key];

                if (Array.isArray(ref)) {
                    dataToSave[key] = ref.map(item => item.innerText);
                } else if (ref.value && undefined != ref.value?.innerText) {
                    dataToSave[key] = ref.value.innerText;
                } else if (ref.value) {
                    dataToSave[key] = ref.value;
                }
            });

            globalThis.jsondata = JSON.stringify(dataToSave);
            localStorage.setItem('data', globalThis.jsondata);

        };

        const endEdit = (o, num, pos) => {
            if (o == 'posdata') {
                const excludePos = storeRefs.posdata.map(el => el?.innerText ?? '');
                excludePos[pos] = '';
                const alreadyInPos = excludePos.findIndex(el => el == num);
                const oldPosValue = excludePos[pos];
                if (alreadyInPos > -1) {
                    storeRefs.posdata[alreadyInPos].innerText = oldPosValue;
                    refs.posname[alreadyInPos].innerText = '';
                }
            }
            updateDisplay(o, num, pos);

            event.target?.removeAttribute('contenteditable');
            refs.editingEl.value = null;
            if (event.target?.innerText !== oldValue) {
                store(o);
            }
            oldValue = null;
        };

        const startEdit = el => {
            refs.editingEl.value?.removeAttribute('contenteditable');
            refs.posNameHovered.value = null;
            if (!el) return;
            el.setAttribute('contenteditable', 'true');
            refs.editingEl.value = el;
            nextTick(() => el.focus());

            oldValue = el.innerText;

            const text = el.innerText.trim();
            if (text.length) {
                speakText(text.replace(/\s/g, ','));
            }
        };

        const focusAtEnd = (el) => {
            if (!el) return;
            el.focus();
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = globalThis.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        const editKeydown = async (o, n) => {
            const key = event.key;

            if (o == 'namelist') {
                if (n == storeRefs.totalNamelist.value && (key == 'Enter' || key == 'ArrowDown')) {
                    event.preventDefault();
                    storeRefs.totalNamelist.value++;
                    await nextTick();
                    startEdit(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                } else if (n == storeRefs.totalNamelist.value && key == 'Backspace') {
                    if (storeRefs.namelist[storeRefs.totalNamelist.value - 1].innerText.trim().length) return;
                    event.preventDefault();
                    storeRefs.totalNamelist.value > 1 && storeRefs.totalNamelist.value--;
                    startEdit(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                    focusAtEnd(storeRefs.namelist[storeRefs.totalNamelist.value - 1]);
                } else if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.namelist[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.namelist[n]);
                }
            } else if (o == 'leadernames') {
                if (n == storeRefs.totalLeader.value && (key == 'Enter' || key == 'ArrowDown')) {
                    event.preventDefault();
                    storeRefs.totalLeader.value++;
                    await nextTick();
                    startEdit(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                } else if (n == storeRefs.totalLeader.value && key == 'Backspace') {
                    if (storeRefs.leadernames[storeRefs.totalLeader.value - 1].innerText.trim().length) return;
                    event.preventDefault();
                    storeRefs.totalLeader.value > 1 && storeRefs.totalLeader.value--;
                    startEdit(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                    focusAtEnd(storeRefs.leadernames[storeRefs.totalLeader.value - 1]);
                } else if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.leadernames[n - 2]);
                    focusAtEnd(storeRefs.leadernames[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.leadernames[n]);
                    focusAtEnd(storeRefs.leadernames[n]);
                }
            } else if (o == 'posdata') {
                if (key == 'ArrowUp') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n - storeRefs.totalX.value]);
                    focusAtEnd(storeRefs.posdata[n - storeRefs.totalX.value]);
                } else if (key == 'ArrowDown') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n + storeRefs.totalX.value]);
                    focusAtEnd(storeRefs.posdata[n + storeRefs.totalX.value]);
                } else if (key == 'ArrowLeft' || key == 'Backspace') {
                    const hasText = storeRefs.posdata[n].innerText.trim().length;
                    if (hasText && key == 'Backspace') return;
                    if (!hasText) refs.posname[n].innerText = '';
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n - 1]);
                    focusAtEnd(storeRefs.posdata[n - 1]);
                } else if (key == 'ArrowRight' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.posdata[n + 1]);
                    focusAtEnd(storeRefs.posdata[n + 1]);
                }
            } else if (o == 'leaders') {
                if (key == 'ArrowUp' || key == 'Backspace') {
                    const hasText = storeRefs.leaders[n - 1].innerText.trim().length;
                    if (hasText && key == 'Backspace') return;
                    if (!hasText) refs.leadersname[n - 1].innerText = '';
                    event.preventDefault();
                    startEdit(storeRefs.leaders[n - 2]);
                    focusAtEnd(storeRefs.leaders[n - 2]);
                } else if (key == 'ArrowDown' || key == 'Enter') {
                    event.preventDefault();
                    startEdit(storeRefs.leaders[n]);
                }
            } else if (o == 'nameBgCtl') {
                if (key == 'ArrowUp') {
                    event.preventDefault();
                    refs.nameBgCtl[n - 2]?.focus();
                } else if (key == 'ArrowDown') {
                    event.preventDefault();
                    refs.nameBgCtl[n]?.focus();
                } else if (key == 'Enter') {
                    event.preventDefault();
                    refs.nameBgCtl[n - 1].checked = !refs.nameBgCtl[n - 1]?.checked;
                }
            }
        };

        function convertPhotoToIndexedDB(photoItem, n) {
            let j = 0;
            for (const item of photoItem) {
                if (refs.nameBgCtl.length < n + j || n + j == 0 || isNaN(n)) return;
                const file = item.getAsFile ? item.getAsFile() : item;
                const reader = new FileReader();
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const targetHeight = img.height * 200 / img.width;
                        canvas.width = 200;
                        canvas.height = targetHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        IDBHelper.put('photo', canvas.toDataURL('image/png'), n + j);
                        j++;
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        const splitTextWithSpecialCaseSimple = text => {
            if (!text) return [];

            const isChinese = ch => /[\u4e00-\u9fa5]/.test(ch);
            const textSegments = text.includes('\n')
                ? text.split('\n').filter(segment => segment.length > 0)
                : text.split((isChinese(text[0]) ? /[ ã€€\n\t,ï¼Œã€]+/ : /\n/)).filter(segment => segment.length > 0);
            const cleanedSegments = [];

            for (const segment of textSegments) {
                if (segment.length > 0) {
                    cleanedSegments.push(segment);
                }
            }
            let i = 0;
            const result = [];
            while (i < cleanedSegments.length) {
                if (i + 1 < cleanedSegments.length && cleanedSegments[i].length == 1 && cleanedSegments[i + 1].length == 1) {
                    result.push(`${cleanedSegments[i]} ${cleanedSegments[i + 1]}`);
                    i += 2;
                } else {
                    result.push(cleanedSegments[i]);
                    i++;
                }
            }

            return result.filter(segment => segment.replace(/\s/g, '').length >= 2);
        }

        const editPaste = async (o, n) => {

             const pasteData = splitTextWithSpecialCaseSimple(event.clipboardData?.getData('text').trim() || globalThis.dropData?.trim());
             const photoItem = event.clipboardData?.items && Array.from(event.clipboardData.items).filter(i => i.type.includes('image'));
             if (!['namelist', 'leadernames'].includes(o) || (!pasteData?.length && !photoItem)) return;

            pasteData.length && event.preventDefault();

            if (!pasteData.length && 'namelist' == o) {
                await convertPhotoToIndexedDB(photoItem, n);
            }

            const list = storeRefs[o];
            const startIndex = n - 1;

            globalThis.pasteDataLength = pasteData.length;

            storeRefs.totalNamelist.value = Math.max(pasteData.length + startIndex, storeRefs.totalNamelist.value);
            await nextTick();
            pasteData.forEach((text, j) => {
                let item = list[startIndex + j];
                if (item) {
                    item.innerHTML = text.replace(/(['"])(.*?)\1/g, '$2').trim();
                }
            });

            randomPos();

        };

        const clearStore = () => {
            if (!confirm($gettext("Are you sure you want to clear all entered data?"))) return;
            localStorage.removeItem('data');
            IDBHelper.remove('photo');
            goHome();
        }

        const download = async () => {
            if (!globalThis.jsondata) return;
            let data = JSON.parse(globalThis.jsondata);
            data.photo = await IDBHelper.get('photo');
            data = JSON.stringify(data);

            if (data) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
                const dlAnchorElem = document.createElement('a');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", (storeRefs.tabletitle.value.innerText.trim() || $gettext('Seating charts')) +`_${storeRefs.today.value.innerText}.json`);
                document.body.appendChild(dlAnchorElem);
                dlAnchorElem.click();
                dlAnchorElem.remove();
            }
        };

        const randomPos = () => {
            let rNum, i, studentNums;
            // Ensure namelist is not empty and has valid elements
            for (i = storeRefs.totalNamelist.value; i > 0; i--) {
                if (storeRefs.namelist[i - 1]?.innerText.trim().length) break;
            }

            studentNums = refs.nameBgCtlChecked.value.length
                ? refs.nameBgCtlChecked.value.slice()
                : Array.from({length: i}, (_, index) => index + 1);

            const alreadyInPos = new Set(storeRefs.posdata.map(el => el.innerText).filter(el => el !== ''));

            const validNums = studentNums.filter(num => !alreadyInPos.has(String(num)));

            if (validNums.length) {
                studentNums = validNums;
            } else {
                resetPos();
            }

            const posdatas = storeRefs.posdata.slice().reverse();
            for (const element of posdatas) {
                if (!element.innerText.trim().length) {
                    rNum = Math.floor(Math.random() * studentNums.length);
                    // Check for valid index and valid namelist entry
                    if (storeRefs.namelist[studentNums[rNum] - 1]?.innerText.trim().length) {
                        element.innerText = studentNums[rNum];
                    } else {
                        continue;
                    }

                    studentNums.splice(rNum, 1);
                    if (!studentNums.length) break;
                }
            }

            updateDisplay();
            store();
        };

        const resetPos = () => {
            if (!confirm($gettext("Are you sure you want to clear your current seating arrangement?"))) return;
            storeRefs.posdata.forEach(i => i.innerText = '');
            refs.posname.forEach(i => i.innerText = '');
            store();
        };

        const shareData = async () => {
            if (globalThis.jsondata) {
                const {photo, ...data} = JSON.parse(globalThis.jsondata);
                const zipData = gzipBase64UrlBC(data);
                const url = new URL(location.href);
                url.hash = `data=${zipData}`;
                if (navigator.share) {
                    await navigator.share({
                        title: $gettext("TY's Seating Chart Generator"),
                        text: storeRefs.tabletitle.value.innerText.trim() || $gettext('Seating charts'),
                        url: url.toString()
                    });
                } else {
                    await navigator.clipboard.writeText(url.toString());
                    alert($gettext('Copied to clipboard'));
                }
            }
        };

        const uploadfileChange = (e) => {
            const fileInput = e.target.files?.[0];
            if (!fileInput) return;
            const reader = new FileReader();
            reader.readAsText(fileInput, "UTF-8");
            reader.onload = event => {
                if (!event.target?.result) return;
                let data = JSON.parse(event.target.result);
                if (data.photo) {
                    for (const photos of data.photo) {
                        for (const [key, value] of Object.entries(photos)) {
                            IDBHelper.put('photo', value, parseInt(key));
                        }
                    }
                    delete data.photo;
                }
                data = JSON.stringify(data);
                localStorage.setItem('data', data);
                goHome();
            }
            e.target.value = '';
        };

        const speakText = text => {
            if (!refs.speechVoice.value) return;
            if (!text || speechSynthesis.speaking || !('speechSynthesis' in globalThis)) {
                return;
            }
            speechSynthesis.speak(new SpeechSynthesisUtterance(text));
        }

        const doSpeak = n => {
            if (!refs.speechVoice.value) return;
            const name = storeRefs.namelist[n - 1]?.innerText.trim();
            if (name) {
                const numberText = vue3gettext.current.includes('en') ? `${$gettext('Number')} ${n}` : `${n}${$gettext('Number')}`;
                speakText(`${numberText}, ${name}`);
            }
        }

        const showPos = (n, show) => {
            n && (refs.highlightedPos.value = show ? n : null);
        };

        const dragStart = (index, type) => {
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: type, index: index }));
            event.target.classList?.add('dragging', `${type}-row`);
        };

        const swapElements = (arr, idx1, idx2) => {
            const val1 = parseInt(arr[idx1]?.innerText || '');
            const val2 = parseInt(arr[idx2]?.innerText || '');

            if (arr[idx1]) arr[idx1].innerText = val2 || '';
            if (arr[idx2]) arr[idx2].innerText = val1 || '';

        }

        const setElementValue = (arr, idx, value) => {
            if (arr[idx]) arr[idx].innerText = value || '';
        }

        const drop = async (targetIndex) => {
            event.preventDefault();
            event.stopPropagation();

            if (!event.dataTransfer) return;

            let data = event.dataTransfer.getData('text/plain');
            if ((!(globalThis.getSelection().rangeCount && !globalThis.getSelection().getRangeAt(0).collapsed)) && data.includes('\n')) {
                globalThis.dropData = data;
                editPaste('namelist', 1);
                storeRefs.totalNamelist.value = globalThis.pasteDataLength;
                return;
            }

            let isNamelistRow = event.currentTarget.classList.contains('namelist-row');
            const isLeaderRow = event.currentTarget.classList.contains('leader-row');
            const isSeatRow = event.currentTarget.classList.contains('seat-row');

            if (event.currentTarget == document.body) isNamelistRow = true;

            if (event.dataTransfer.files.length && !isLeaderRow) {
                if (typeof targetIndex != 'number') targetIndex = 1;
                return convertPhotoToIndexedDB(event.dataTransfer.files, isSeatRow ? parseInt(storeRefs.posdata[targetIndex].innerText) : targetIndex);
            }

            try {
                data = JSON.parse(data);
            } catch (e) {
                console.log(e);
                return;
            }

            let isVaild = false;

            const sourceIndex = parseInt(data.index);

            const actions = [{
                condition: () => data.type == 'student' && isSeatRow,
                    action: () => {
                        if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                        const targetElement = storeRefs.posdata.find(el => el.innerText.trim() == sourceIndex);
                        const oldValue = storeRefs.posdata[targetIndex].innerText;
                        if (targetElement) {
                            storeRefs.posdata[targetIndex].innerText = targetElement.innerText;
                            targetElement.innerText = oldValue;
                        }
                        setElementValue(storeRefs.posdata, targetIndex, sourceIndex);
                        isVaild = true;
                    }
                },
                {
                    condition: () => data.type == 'seat' && isSeatRow,
                    action: () => {
                        if (sourceIndex == targetIndex) return;
                        swapElements(storeRefs.posdata, sourceIndex, targetIndex);
                        isVaild = true;
                    }
                },
                {
                    condition: () => data.type == 'seat' && isLeaderRow,
                    action: () => {
                        const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                        setElementValue(storeRefs.leaders, targetIndex, sourceNum);
                        isVaild = true;
                    }
                },
                {
                    condition: () => data.type == 'seat' && isNamelistRow,
                    action: () => {
                        const sourceNum = parseInt(storeRefs.posdata[sourceIndex]?.innerText || '');
                        if (refs.nameBgCtl[sourceNum - 1]) refs.nameBgCtl[sourceNum - 1].checked = false;
                        setElementValue(storeRefs.posdata, sourceIndex, '');
                        isVaild = true;
                    }
                },
                {
                    condition: () => data.type == 'leader' && isLeaderRow,
                    action: () => {
                        if (sourceIndex == targetIndex) return;
                        swapElements(storeRefs.leaders, sourceIndex, targetIndex);
                        if (!storeRefs.leaders[sourceIndex]?.innerText.trim().length) {
                            setElementValue(refs.leadersname, sourceIndex, '');
                        }
                        isVaild = true;
                    }
                },
                {
                    condition: () => data.type == 'student' && isLeaderRow,
                    action: () => {
                        if (sourceIndex < 1 || sourceIndex > storeRefs.totalNamelist.value) return;
                        setElementValue(storeRefs.leaders, targetIndex, sourceIndex);
                        isVaild = true;
                    }
                }
            ];

            for (const { condition, action } of actions) {
                if (condition()) {
                    action();
                    break;
                }
            }

            document.querySelectorAll('.seat-container').forEach(el => el.classList.remove('dragging'));

            if (!isVaild) return;
            store();
            updateDisplay();
        };

        const toggleColor = event => {
            const el = event.currentTarget;
            let currentIndex = refs.colors.findIndex(c => el.classList.contains(c));

            if (currentIndex == -1) {
                el.classList.add(refs.colors[Math.max(refs.colorIndex.value, 0)]);
                return;
            }
            el.classList.remove(refs.colors[currentIndex]);
            if (currentIndex == refs.colors.length - 1) {
                return;
            }
            if (refs.colorIndex.value != 0) el.classList.add(refs.colors[currentIndex + 1]);
        };

        const fontSizeMap = {
            r: "fontSizeR",
            c: "fontSizeC",
            l: "fontSizeL"
        };
        const adujstFont = async (direction) => {

            const key = fontSizeMap[refs.fontPos.value];
            if (key) {
                const val = storeRefs[key].value + (direction == "+" ? 0.1 : -0.1);
                if (val >= 0.5) {
                    storeRefs[key].value = Math.round(val * 10) / 10;
                    store();
                }
            }
        };

        const fontButtonCtl = computed(() => {
            const key = fontSizeMap[refs.fontPos.value];
            return storeRefs[key].value <= 0.5;
        });

        const nameBtnCtlChange = (e) => {
            refs.nameBgCtlChecked.value = refs.nameBgCtl.filter(c => e.target.checked && c.value.trim() != '').map(c => parseInt(c.value));
        };

        const binGo = () => {
            refs.bingoButtonCtl.value = true;
            refs.doBingo.value = true;
            let arr = storeRefs.posdata.map(i => Number(i.innerText)).filter(Boolean);

            if (refs.nameBgCtlChecked.value.length < 1) {
                refs.nameBtnCtl.value.checked = true;
                refs.nameBgCtlChecked.value = arr;
            } else {
                arr = arr.filter(i => refs.nameBgCtlChecked.value.includes(i));
            }

            const finalNumber = Math.floor(Math.random() * arr.length);
            let current = 0;

            const getDelay = (i, arrLength) => {
                const t = i / arrLength;
                const minDelay = 50;
                const maxDelay = 200;

                if (t < 0.3) {
                    return maxDelay - (maxDelay - minDelay) * (t / 0.3);
                } else if (t < 0.7) {
                    return minDelay;
                } else if (t <= 0.9) {
                    return maxDelay - (maxDelay - minDelay) * (((t - 0.7) / 0.3) ** 2);
                }
                return maxDelay - (maxDelay - minDelay) * (((t - 0.7) / 0.3) ** 20);
            };

            function roll(i) {
                current = (current % arr.length) + 1;
                showPos(arr[current - 1], 1);
                showPhoto(arr[current - 1]);

                if (i < arr.length) {
                    setTimeout(() => roll(i + 1), getDelay(i, arr.length));
                } else {
                    showPos(arr[finalNumber], 1);
                    showPhoto(arr[finalNumber]);
                    refs.nameBgCtlChecked.value = refs.nameBgCtlChecked.value.filter(n => n != arr[finalNumber]);
                    refs.bingoButtonCtl.value = false;
                }
            }

            roll(0);
        };

        const showPhoto = n => {
            if (!n) return;
            IDBHelper.get('photo', n).then(img => {
                refs.photo.value = img?.length ? img : null;
            });
            const numPos = storeRefs.posdata.findIndex(i => i.innerText == n);
            const row = (numPos % storeRefs.totalX.value) + 1;
            const column = storeRefs.totalY.value - Math.floor(numPos / storeRefs.totalY.value);
            refs.seatsPos.value = `${row}-${column}`;
            refs.photoNo.value = n;
            refs.photoName.value = storeRefs.namelist[n - 1].innerText;
        };

        const setTitle = event => {
            event.currentTarget.title = event.currentTarget.innerText;
        };

        const storeRefs = {
            tabletitle: ref($gettext('Seating charts')),
            today: ref(new Date().toLocaleDateString()),
            totalX: ref(6),
            totalY: ref(8),
            totalNamelist: ref(48),
            totalLeader: ref(8),
            namelist: reactive([]),
            posdata: reactive([]),
            teacher: ref(null),
            leadernames: reactive([]),
            leaders: reactive([]),
            deskname: ref($gettext('Desk')),
            updateLabel: ref($gettext('Update')),
            teacherLabel: ref($gettext('Teacher')),
            studentListLabel: ref($gettext('Lists')),
            noteLabel: ref($gettext('Note')),
            note: ref(''),
            fontSizeL: ref(1),
            fontSizeC: ref(1.8),
            fontSizeR: ref(1.2)
        };

        const refs = {
            toggleNavbar: ref(localStorage.getItem('toggleNavbar') == 1),
            toggleSubmenu: ref(false),
            toggleOptionmenu: ref(false),
            totalnums: ref(48),
            storeData: ref(0),
            posname: reactive([]),
            posindex: ref(0),
            leadersname: reactive([]),
            clearBtnCtl: ref(0),
            isDataChanged: ref(0),
            nameBgCtlChecked: ref([]),
            nameBgCtl: reactive([]),
            hideTips: ref(false),
            highlightedPos: ref(null),
            colors: reactive(Array.from({ length: 10 }, (_, i) => `color-${i}`)),
            colorIndex: ref(-1),
            currentTarget: ref(null),
            currentIndex: ref(0),
            showList: ref(localStorage.getItem('showList') == null),
            showSeats: ref(localStorage.getItem('showSeats') == null),
            showNumber: ref(localStorage.getItem('showNumber') == null),
            showPlace: ref(localStorage.getItem('showPlace') == null),
            showName: ref(localStorage.getItem('showName') == null),
            showLeader: ref(localStorage.getItem('showLeader') == null),
            showNote: ref(localStorage.getItem('showNote') == null),
            showVertical: ref(localStorage.getItem('showVertical') == null),
            showFonts: ref(setFonts(localStorage.getItem('showFonts')) || ''),
            speechVoice: ref(localStorage.getItem('speechVoice') == null || ''),
            showDate: ref(localStorage.getItem('showDate') == null),
            showDesk: ref(localStorage.getItem('showDesk') == null),
            fontPos: ref('c'),
            nameBtnCtl: ref(false),
            editingEl: ref(null),
            bingoButtonCtl: ref(false),
            photo: ref(null),
            seatsPos: ref(''),
            photoNo: ref(''),
            photoName: ref(''),
            posNameHovered: ref(null),
            doBingo: ref(false),
            storeSelected: ref('')
        };

        return {
            ...storeRefs,
            ...refs,
            goHome,
            toggleNavBarCtl,
            startEdit,
            endEdit,
            editKeydown,
            editPaste,
            store,
            clearStore,
            download,
            randomPos,
            resetPos,
            shareData,
            uploadfileChange,
            updateDisplay,
            tipsToHide,
            getCookie,
            showPos,
            dragStart,
            drop,
            toggleColor,
            adujstFont,
            fontButtonCtl,
            nameBtnCtlChange,
            binGo,
            IDBHelper,
            showPhoto,
            doSpeak,
            setTitle
        };
    },
    watch: {
        showList(newVal) {
            newVal ? localStorage.removeItem('showList') : localStorage.setItem('showList', 0);
        },
        showSeats(newVal) {
            newVal ? localStorage.removeItem('showSeats') : localStorage.setItem('showSeats', 0);
        },
        showNumber(newVal) {
            newVal ? localStorage.removeItem('showNumber') : localStorage.setItem('showNumber', 0);
        },
        showPlace(newVal) {
            newVal ? localStorage.removeItem('showPlace') : localStorage.setItem('showPlace', 0);
        },
        showName(newVal) {
            newVal ? localStorage.removeItem('showName') : localStorage.setItem('showName', 0);
        },
        showLeader(newVal) {
            newVal ? localStorage.removeItem('showLeader') : localStorage.setItem('showLeader', 0);
        },
        showNote(newVal) {
            newVal ? localStorage.removeItem('showNote') : localStorage.setItem('showNote', 0);
        },
        showVertical(newVal) {
            newVal ? localStorage.removeItem('showVertical') : localStorage.setItem('showVertical', 0);
        },
        showFonts(newVal) {
            setFonts(newVal);
        },
        speechVoice(newVal) {
            newVal ? localStorage.removeItem('speechVoice') : localStorage.setItem('speechVoice', 0);
        },
        showDate(newVal) {
            newVal ? localStorage.removeItem('showDate') : localStorage.setItem('showDate', 0);
        },
        showDesk(newVal) {
            newVal ? localStorage.removeItem('showDesk') : localStorage.setItem('showDesk', 0);
        }
    },
    async mounted() {

        if (document.title == "TY's Seating Chart Generator") document.title = $gettext('Seating charts');

        if (this.leadernames) {
            if (this.leadernames[0] && !this.leadernames[0].innerText.length) this.leadernames[0].innerText = $gettext('President');
            if (this.leadernames[1] && !this.leadernames[1].innerText.length) this.leadernames[1].innerText = $gettext('Vice president');
        }

        globalThis.dkeys?.forEach(i => {

            if (Array.isArray(i[1]) && i[1][0] != null) {
                i[1].forEach((_, j) => {
                    if (this[i[0]] && undefined != this[i[0]][j]?.innerHTML)
                        this[i[0]][j].innerHTML = i[1][j];
                });
            } else if (undefined != this[i[0]]?.innerHTML)
                this[i[0]].innerHTML = i[1].replaceAll('\n', '<br>');
            else if (undefined != this[i[0]]?.value)
                this[i[0]].value = i[1];

        });

        await nextTick();

        this.updateDisplay();
        this.storeData = 1;

        if ('speechSynthesis' in globalThis) {
            speechSynthesis.speak(new SpeechSynthesisUtterance(""));
        }

        if (this.today.innerText == '') this.today.innerText = new Date().toLocaleDateString();

        document.body.addEventListener('dragover', (e) => e.preventDefault());
        document.body.addEventListener('drop', this.drop);

    }

});

const vue3gettext = VueGettext.createGettext({
    availableLanguages: {
        en: "English",
        zh_TW: "Chinese"
    },
    silent: true,
    defaultLanguage: navigator.language.replace('-', '_'),
    translations: {
        "zh_TW": {
            "TY's Seating Chart Generator": "TYçš„åº§ä½è¡¨ç”¢ç”Ÿå™¨",
            "Seat assigned": "å·²æ’ä½å­",
            "Are you sure you want to clear all entered data?": "ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨è¼¸å…¥çš„è³‡æ–™å—?",
            "Are you sure you want to clear your current seating arrangement?": "ç¢ºå®šè¦æ¸…é™¤ç›®å‰çš„åº§ä½æ’åˆ—å—?",
            "President": "ç­é•·",
            "Clear": "æ¸…é™¤",
            "Desk": "è¬›æ¡Œ",
            "Download": "ä¸‹è¼‰",
            "Not enough seats!": "åº§ä½æ•¸ä¸å¤ å!",
            "Columns": "æ’",
            "Leaders": "è‚¡é•·",
            "Seats": "åº§ä½",
            "Rows": "åˆ—",
            "Please directly click on the name or seat number area to enter information": "è«‹ç›´æ¥é»é¸å§“åæˆ–åº§è™Ÿå€åŸŸè¼¸å…¥è³‡æ–™",
            "Random": "éš¨æ©Ÿ",
            "Reset": "é‡ç½®",
            "Seating charts": "åº§ä½è¡¨",
            "Lists": "åå–®",
            "Teacher": "å°å¸«",
            "Date": "æ—¥æœŸ",
            "Upload": "ä¸Šå‚³",
            "Vice president": "å‰¯ç­é•·",
            "Left": "å·¦",
            "Center": "ä¸­",
            "Right": "å³",
            "Font size": "å­—é«”å¤§å°",
            "Fonts": "å­—é«”",
            "ZhuYin": "æ³¨éŸ³",
            "PinYin": "æ‹¼éŸ³",
            "Both": "å…©è€…",
            "Print": "åˆ—å°",
            "Note": "å‚™è¨»",
            "Bingo": "æŠ½ç±¤",
            "Numbers": "åº§è™Ÿ",
            "Place": "ä½ç½®",
            "Names": "å§“å",
            "Number": "è™Ÿ",
            "Vertical": "å‚ç›´",
            "Share": "åˆ†äº«",
            "Copied to clipboard": "å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿",
            "Methods": "åŠŸèƒ½",
            "Options": "é¸é …",
            "Voice": "èªéŸ³"
        }
    }
});

globalThis.$gettext = vue3gettext.$gettext;
app.use(vue3gettext).mount('#app');

</script>
</body>
</html>

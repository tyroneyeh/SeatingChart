<!doctype html>
<html lang="zh-Hant-TW">
<head>
<title>座位表</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
<div id="app" class="container-fluid">
    <div class="d-print-none card m-1">
        <!-- top area -->
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav m-auto">
                        <span class="nav-link" aria-current="page">全班人數: <input type="number" style="width:60px" v-model="totalNum" min="1" ref="totalnums" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link">排數: <input type="number" style="width:60px" v-model="totalX" min="1" ref="totalxs" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link">列數: <input type="number" style="width:60px" v-model="totalY" min="1" ref="totalys" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link">股長數: <input type="number" style="width:60px" v-model="totalLeader" min="1" ref="totalleaders" @change="store" @focus="$event.target.select()"></span>
                        <span class="nav-link"><button class="form-control-sm" @click="clearStore" v-if="storeData">清除資料</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="download" v-if="storeData">下載資料</button></span>
                        <span class="nav-link"><input type="file" ref="uploadfile" @change="uploadfileChange" class="d-none" accept="application/json"><button class="form-control-sm" @click="uploadData">上傳資料</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="clearPos">清除座位</button></span>
                        <span class="nav-link"><button class="form-control-sm" @click="randomPos">隨機座位</button></span>
                    </div>
                </div>
            </div>
        </nav>
        <div class="input-group-text m-auto">請直接點選姓名或座號區域輸入資料</div>

    </div>
    <div class="row m-auto" :class="xColClass">
        <div class="col-2"></div>
        <div class="text-center col-7 fs-4" @click="clickToEdit()" ref="tabletitle">座位表</div>
        <div class="col-2 align-self-end text-nowrap">更新日期: <span @click="clickToEdit()" ref="today">{{ new Date().toLocaleDateString() }} </span></div>
    </div>

    <div class="row col-sm-12 mx-auto" :class="xColClass">
        <div class="pt-1" :class="xColClassStart">
            <!-- left area -->
            <div class="text-center border-start border border-secondary" style="margin-left:-12px;margin-right:-12px">班級名條</div>
            <div class="row" :class="{'border-bottom border-secondary': n % 5 == 0}" :style="{'background-color': n % 2 == 0 ? '#eee' : ''}" v-for="n in totalNum">
                <div class="col-4 border-start border-bottom text-center pe-0">{{ String(n).padStart(2, '0') }}</div>
                <div class="col border-start border-bottom border-end text-nowrap overflow-auto" @click="clickToEdit(String(n).padStart(2, '0'))" :id="'no_'+ String(n).padStart(2, '0')" ref="namelist"></div>
            </div>

        </div>
        <div class="ps-4 pb-3" :class="xColClassCenter">
            <!-- center area -->
            <div class="row flex-nowrap" v-for="x in totalY">
                <div class="col p-1" v-for="y in totalX">
                    <div class="col p-0">
                        <div class="col border text-center" @click="clickToEdit(x, y)" :id="'pos_'+ x +'_'+ y" ref="posdata">&nbsp;</div>
                        <div class="col border text-center w-100 p-3 overflow-auto" style="height:100px"><span class="text-nowrap fs-5" style="-webkit-writing-mode:vertical-lr;writing-mode: vertical-lr;" ref="posname">&nbsp;</span></div>
                    </div>
                </div>
            </div>
            <div class="row m-4">
                <div class="mx-auto pt-2 mb-5 text-center" style="text-align-last:justify;width:90px;height:63px;background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABACAYAAACa5WD/AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAc1JREFUeJzt2LFqwmAYheHzf0RB6eaVOInX4J6Lc3Z3EgdxayveQnsL2WwqxJp0sW3UxIL5PbHpeTalhY8XOZC4+XyeQW5ms9kEYRjure5D/guFJlFoEoUmUWgShSZRaBKFJlFoEoUmUWgShSZRaBKFJlFoEoUmCeo+4JLVagWzy7+FNE0xHA5JF13vrkObGQaDwcW/Wa/XpGuq0XSQKDSJQpMoNIlCkyg0iUKTKDSJQpPc9ZNhFEW/PvlFUUS6ppq7Dj0ajeo+wRtNB4lCkyg0iUKTKDSJQpMoNIlCkyg0iUKTKDSJQpME0+m07hsaq9/vo9frAQAsCO76Bd6f1Wq10O12vz/bbrdLarynsZIkSRaLxUMYhnsAMOfca91HNdTLZDKJvz5YmqYzAB81HtREezOb5b8w59wSQFzyD3KdNwDL/BfmnHvMsqxT00GNlGVZJ47j5/x3Nh6P37XT3h3tM3B4YNFOe3W2z8AhtHbaq7N9Bn5Ca6c9Kdpn4BBaO+3V2T4DuZdK2mkvCvcZyIXWTntRuM/AcWjtdEVl+wzkQmunvSjcZ+Dkxb92upLSfQZOQmunKyndZ+Ak9Ha7fQLQvvVFDdUu22cRkSt9AicbkgadtfvPAAAAAElFTkSuQmCC');">講台</div>
            </div>
        </div>
        <div class="pt-1" :class="xColClassEnd">
            <!-- right area -->
            <table class="table table-bordered table-striped">
                <caption></caption>
                <thead>
                <tr>
                    <th style="text-align-last:justify">導師</th>
                    <th colspan="2" class="w-50 text-center ps-0 pe-0 text-nowrap" @click="clickToEdit()" ref="teacher">&nbsp;</th>
                </tr>
                </thead>
                <tr v-for="n in totalLeader">
                    <td class="text-end text-nowrap" style="text-align-last:justify" @click="clickToEdit()" ref="leadernames">{{ leadernames[n - 1]?.innerText }}</td>
                    <td class="text-center ps-0 pe-0" style="display:block;width:50px" @click="clickToEdit()" :id="'leader_'+ n" ref="leaders">&nbsp;</td>
                    <td class="text-nowrap" ref="leadersname">&nbsp;</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
const { createApp, ref, reactive, watch } = Vue;
window.randomNumbers = [];

createApp({
    setup() {
        const storeRefs = {
            tabletitle: ref('座位表'),
            today: ref(new Date().toLocaleDateString()),
            totalNum: ref(40),
            totalX: ref(6),
            totalY: ref(8),
            totalLeader: ref(8),
            namelist: reactive([]),
            posdata: reactive([]),
            teacher: ref(null),
            leadernames: reactive([]),
            leaders: reactive([])
        };
        const refs = {
            uploadfile: ref(null),
            storeData: ref(0),
            xColClass: ref('col-lg-7 col-md-12'),
            xColClassStart: ref('col-2 col-md-2'),
            xColClassCenter: ref('col-7'),
            xColClassEnd: ref('col-3 col-md-1'),
            posname: reactive([]),
            leadersname: reactive([])
        };

        watch([storeRefs.totalNum, storeRefs.totalX, storeRefs.totalY], async(_, oldValues) => {
            if (storeRefs.totalX.value * storeRefs.totalY.value < storeRefs.totalNum.value) {
                storeRefs.totalNum.value = oldValues[0];
                storeRefs.totalX.value = oldValues[1];
                storeRefs.totalY.value = oldValues[2];
                alert("座位數不夠坐!");
            }
        });

        watch(storeRefs.totalX, async(i) => {
            if (i > 8) {
                xColClass.value = 'col-lg-12 col-md-12';
                xColClassStart.value = 'col-1';
                xColClassCenter.value = 'col-9';
                xColClassEnd.value = 'col-2';
            } else {
                xColClass.value = 'col-lg-8';
                xColClassStart.value = 'col-2 col-md-2';
                xColClassCenter.value = 'col-7';
                xColClassEnd.value = 'col-3 col-md-1';
            }
        });


        const updatedisplay = () => {
            storeRefs.posdata.forEach((i, j) => {
                const num = parseInt(i.innerText.trim());
                if (!isNaN(num)) {
                    const no = storeRefs?.namelist[num - 1];
                    if (no) {
                        refs.posname[j].innerText = no.innerText;
                        if (!randomNumbers.includes(num))
                            randomNumbers.push(num);
                    }
                } else
                    refs.posname[j].innerHTML = '&nbsp;';
            });

            storeRefs.leaders.forEach((i, j) => {
                const num = parseInt(i.innerText.trim());
                if (!isNaN(num)) {
                    const no = storeRefs.namelist[num - 1];
                    if (no)
                        refs.leadersname[j].innerText = no.innerText;
                }
            });

        };

        const store = () => {
            const datakeys = Object.keys(storeRefs);
            const tojson = {};
            datakeys.forEach((i) => {

                if (Array.isArray(storeRefs[i])) {
                    tojson[i] = [];
                    if (i == 'posdata') {
                        const posNum = storeRefs.totalX.value * storeRefs.totalY.value;
                        for (let k = 0; k < posNum; k++) {
                            tojson[i].push(storeRefs[i][k].innerText);
                        }
                    } else
                        Object.keys(storeRefs[i]).forEach((j) => {
                            tojson[i].push(storeRefs[i][j].innerText);
                        });
                } else {
                    const value = storeRefs[i].value?.innerText || storeRefs[i].value;
                    tojson[i] = value;
                }

            });

            localStorage.setItem('data', JSON.stringify(tojson));
            updatedisplay();

        };

        const clearStore = () => {
            if (!confirm("確定要清除全部輸入的資料嗎?"))
                return;

            localStorage.removeItem('data');
            location.reload();
        };

        const clearPos = () => {
            if (!confirm("確定要清除目前的座位排列嗎?"))
                return;

            storeRefs.posdata.forEach((i) => { i.innerHTML = '&nbsp;'; });
            store();
            window.randomNumbers = [];
            // location.reload();
        };

        const clickToEdit = (n) => {
            // let divContainer = n ? document.getElementById('no_'+ n) : event.target;
            // if (y)
                // divContainer = n ? document.getElementById('pos_'+ n +'_'+ y) : event.target;
            const divContainer = event.target;

            if (divContainer) {
                const inputElement = document.createElement('input');
                inputElement.classList.add('from-control-sm');
                inputElement.setAttribute('type', ['pos_', 'leader_'].includes(divContainer.id.slice(0, divContainer.id.indexOf('_') + 1)) ? 'number' : 'text');
                inputElement.setAttribute('min', 1);
                inputElement.style.width = "100%";
                inputElement.style.height = "24px";

                inputElement.value = divContainer.innerText.trim();

                divContainer.innerHTML = '';
                divContainer.appendChild(inputElement);
                inputElement.addEventListener('blur', () => {
                    if (!isNaN(parseInt(inputElement.value))) {
                        divContainer.innerText = String(inputElement.value).padStart(2, '0');
                        const pname = divContainer.closest('div.oneset') || divContainer.closest('tr.oneset');
                        const sname = document.getElementById('no_'+ divContainer.innerText);
                        if (pname && sname && sname.innerText.length) {
                            pname.querySelector('.sname').innerText = sname.innerText;
                        }
                    } else
                        divContainer.innerHTML = inputElement.value.length ? inputElement.value : '&nbsp;';

                    store();
                    refs.storeData.value = 1;
                });

                inputElement.addEventListener('keydown', (e) => {
                    n = parseInt(event.target.parentElement.id.replace(/[^\d]+/, ''));
                    if (e.shiftKey && e.key === 'Tab' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (y) {
                            if (n > 1)
                                clickToEdit(n - 1, y);
                            else
                                clickToEdit(totalX.value, y - 1);
                        } else
                            clickToEdit(String(n - 1).padStart(2, '0'));
                    } else if (['Enter', 'Tab', 'ArrowDown'].includes(e.key)) {
                        e.preventDefault();
                        // if (y) {
                        //     if (n >= totalX.value)
                        //         clickToEdit(1, y + 1);
                        //     else
                        //         clickToEdit(n + 1, y);
                        // } else
                            clickToEdit(String(n + 1).padStart(2, '0'));
                    }
                });
                inputElement.addEventListener('paste', (e) => {
                    let pasteData = e.clipboardData.getData('text');
                    pasteData = pasteData.trim().split(/\r\n| |,|\n/);
                    if (pasteData?.length > 1) {
                        e.stopPropagation();
                        e.preventDefault();
                        let no = parseInt(e.target.parentElement.id.replace(/no_/, ''));
                        const sname = document.getElementById('no_'+ String(no).padStart(2, '0'))
                        if (sname)
                            sname.innerText = pasteData[0];
                        pasteData.forEach((i) => {
                            const sname = document.getElementById('no_'+ String(no++).padStart(2, '0'));
                            if (sname)
                                sname.innerText = i;
                        });
                        store();

                    }
                });

                inputElement.focus();

            }
        };

        const download = () => {
            let data = localStorage.getItem('data');

            if (data) {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(data);
                const dlAnchorElem = document.createElement('a');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", "seatingtable.json");
                dlAnchorElem.click();
            }
        };

        const uploadData = () => {
            refs.uploadfile.value.click();
        };

        const randomPos = () => {
            let rNum;
            let j;
            const posdatas = storeRefs.posdata.slice();
            posdatas.reverse().forEach((i) => {
                j = 0;
                while(!i.innerText.trim().length) {
                    if (j++ > storeRefs.totalNum.value << 2) break;
                    rNum = Math.floor(Math.random() * storeRefs.totalNum.value) + 1;
                    if (!window.randomNumbers.includes(rNum)) {
                        i.innerText = String(rNum).padStart(2, '0');
                        window.randomNumbers.push(rNum);
                    }
                }
            });

            store();
        };

        const uploadfileChange = () => {
            const reader = new FileReader();
            reader.readAsText(refs.uploadfile.value.files[0], "UTF-8");
            reader.onload = (evt) => {
                localStorage.setItem('data', evt.target.result);
                location.reload();
            }
        };

        return {
            ...storeRefs,
            ...refs,
            clickToEdit,
            store,
            clearStore,
            download,
            uploadData,
            randomPos,
            clearPos,
            uploadfileChange,
            updatedisplay
        };
    }, beforeCreate() {
        window.data = localStorage.getItem('data');
        if (data) {
            window.data = JSON.parse(data);
            window.dkeys = Object.keys(data);
            dkeys.forEach((i) => {
                if ('tabletitle' == i)
                    document.title = data[i];
                else if ('today' == i)
                    this.today = data[i];
                else if ('totalNum' == i)
                    this.totalNum = parseInt(data[i]);
                else if ('totalX' == i)
                    this.totalX = parseInt(data[i]);
                else if ('totalY' == i)
                    this.totalY = parseInt(data[i]);
                else if ('totalLeader' == i)
                    this.totalLeader = parseInt(data[i]);

            });
        }
    }, mounted() {

        if (!this.leadernames[0].innerText.length) this.leadernames[0].innerText = '班長';
        if (!this.leadernames[1].innerText.length) this.leadernames[1].innerText = '副班長';

        if (data) {
            dkeys.forEach((i) => {
                if (data[i][0] != null && Array.isArray(data[i])) {
                    data[i].forEach((_, j) => {
                        if (this[i][j]?.innerText != undefined)
                            this[i][j].innerText = data[i][j];
                    });
                } else if (this[i]?.innerText != undefined)
                    this[i].innerText = data[i];
                else if (this[i]?.value != undefined)
                    this[i].value = data[i];


            });

            this.updatedisplay();
            this.storeData = 1;
        }
    }
}).mount('#app')
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

</body>
</html>
